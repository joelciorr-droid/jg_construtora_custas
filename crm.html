<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>JG | CRM</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
<div class="container">

  <div class="card no-print" style="display:flex;gap:10px;align-items:center;justify-content:space-between">
    <div style="display:flex;gap:10px;align-items:center">
      <b>JG | CRM</b>
      <span class="badge" id="whoMini"></span>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <a class="btn secondary" href="index.html">Simulador</a>
      <a class="btn secondary" href="crm.html">CRM</a>
      <a class="btn secondary" id="adminLinkTop" href="admin.html" style="display:none">Admin/Config</a>
      <button class="btn secondary" id="btnLogoutTop" style="display:none">Sair</button>
    </div>
  </div>

  <!-- LOGIN -->
  <div class="card no-print" id="loginCard">
    <h2>Entrar</h2>
    <div class="row row-2">
      <div>
        <label>E-mail</label>
        <input id="email" type="email" autocomplete="username"/>
      </div>
      <div>
        <label>Senha</label>
        <input id="password" type="password" autocomplete="current-password"/>
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <button class="btn" id="btnLogin">Entrar</button>
      <span class="badge" id="who"></span>
    </div>
    <div id="msg" style="margin-top:12px"></div>
  </div>

  <!-- TROCA DE SENHA OBRIGATÓRIA -->
  <div class="card no-print" id="changePassCard" style="display:none">
    <h2>Troca de senha obrigatória</h2>
    <div class="muted">Defina sua nova senha para continuar.</div>
    <div class="hr"></div>

    <div class="row row-2">
      <div>
        <label>Nova senha</label>
        <input id="newPass" type="password" autocomplete="new-password"/>
      </div>
      <div>
        <label>Confirmar nova senha</label>
        <input id="newPass2" type="password" autocomplete="new-password"/>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnChangePass">Salvar nova senha</button>
      <button class="btn secondary" id="btnChangePassLogout">Sair</button>
    </div>

    <div id="msgPass" style="margin-top:12px"></div>
  </div>

  <div class="card no-print" id="crmCard" style="display:none">
    <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
      <div>
        <label>Buscar</label>
        <input id="q" placeholder="Nome, telefone, status..." />
      </div>
      <div>
        <label>Status</label>
        <select id="status">
          <option value="">Todos</option>
          <option value="NOVO">NOVO</option>
          <option value="EM_ATENDIMENTO">EM_ATENDIMENTO</option>
          <option value="PROPOSTA">PROPOSTA</option>
          <option value="FECHADO">FECHADO</option>
          <option value="PERDIDO">PERDIDO</option>
        </select>
      </div>
      <div style="display:flex;gap:10px">
        <button class="btn" id="btnRefresh">Atualizar</button>
      </div>
    </div>

    <div class="hr"></div>
    <div id="tableWrap"></div>
    <div id="msg2" style="margin-top:12px"></div>
  </div>

</div>

<script src="app.js"></script>
<script>
let ALL = [];
let LAST = [];
let USER = null;

function showMsg(el, txt, ok=true){
  el.innerHTML = '<div class="notice '+(ok?'ok':'err')+'">'+txt+'</div>';
}

function lockForPasswordChange(){
  $('changePassCard').style.display = 'block';
  $('crmCard').style.display = 'none';
}
function unlockAfterPasswordChange(){
  $('changePassCard').style.display = 'none';
  $('crmCard').style.display = 'block';
}

function refreshMenu(){
  const {token,user} = getSession();
  USER = user;
  $('whoMini').textContent = token ? (user.name+' ('+user.role+')') : '';
  $('adminLinkTop').style.display = (token && user.role==='ADMIN') ? 'inline-flex' : 'none';
  $('btnLogoutTop').style.display = token ? 'inline-flex' : 'none';

  $('loginCard').style.display = token ? 'none' : 'block';
  $('crmCard').style.display = token ? 'block' : 'none';
  $('who').textContent = token ? (user.name+' ('+user.role+')') : '';
}

function doLogout(){
  clearSession();
  refreshMenu();
  $('crmCard').style.display = 'none';
  $('tableWrap').innerHTML = '';
  showMsg($('msg'), 'Sessão encerrada.', true);
}
$('btnLogoutTop').onclick = doLogout;

$('btnLogin').onclick = async ()=>{
  try{
    const r = await apiPost({action:'login', email:$('email').value, password:$('password').value});
    if(!r.ok) return showMsg($('msg'), r.error || 'Erro no login', false);

    setSession(r.token, r.user);
    refreshMenu();

    if (r.user && r.user.mustChangePassword){
      lockForPasswordChange();
      showMsg($('msg'), 'Você precisa trocar sua senha para continuar.', false);
      return;
    }

    await load();
  }catch(e){
    showMsg($('msg'), String(e), false);
  }
};

$('btnChangePass').onclick = async ()=>{
  try{
    const {token} = getSession();
    if(!token) return showMsg($('msgPass'), 'Sem sessão. Faça login novamente.', false);

    const newPassword = $('newPass').value;
    const confirmPassword = $('newPass2').value;

    const r = await apiPost({ action:'changePassword', token, newPassword, confirmPassword });
    if(!r.ok) return showMsg($('msgPass'), r.error || 'Erro ao trocar senha.', false);

    showMsg($('msgPass'), 'Senha alterada com sucesso. Faça login novamente.', true);

    clearSession();
    refreshMenu();
    unlockAfterPasswordChange();
    $('newPass').value = '';
    $('newPass2').value = '';
  } catch(e){
    showMsg($('msgPass'), String(e), false);
  }
};
$('btnChangePassLogout').onclick = doLogout;

function parseTS(x){
  const d = new Date(x);
  return Number.isNaN(d.getTime()) ? 0 : d.getTime();
}

function computeLastByLead(rows){
  const map = new Map();
  for(const r of rows){
    const id = r.lead_id || (r.cliente_telefone || r.cliente_nome || 'SEM_ID');
    const ts = parseTS(r.updated_at || r.created_at || r.data_simulacao || 0);
    const prev = map.get(id);
    if(!prev || ts >= prev._ts){
      map.set(id, {...r, _ts: ts, lead_id: id});
    }
  }
  return Array.from(map.values()).sort((a,b)=> b._ts - a._ts);
}

function filterRows(rows){
  const q = $('q').value.trim().toLowerCase();
  const st = $('status').value;

  return rows.filter(r=>{
    const hay = [r.cliente_nome, r.cliente_telefone, r.status, r.cidade, r.tipo_financiamento].join(' ').toLowerCase();
    if(st && (String(r.status||'').toUpperCase() !== st)) return false;
    if(q && !hay.includes(q)) return false;
    return true;
  });
}

function rowBtn(label, onClick){
  const b = document.createElement('button');
  b.className = 'btn secondary';
  b.textContent = label;
  b.onclick = onClick;
  return b;
}

function renderTable(rows){
  const data = filterRows(rows);

  const wrap = document.createElement('div');
  const table = document.createElement('table');
  table.className = 'table';
  table.style.width = '100%';

  table.innerHTML = `
    <thead>
      <tr>
        <th>Data</th>
        <th>Cliente</th>
        <th>Telefone</th>
        <th>Status</th>
        <th>Cidade</th>
        <th>Total</th>
        <th>Financia</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;

  const tbody = table.querySelector('tbody');

  for(const r of data){
    const tr = document.createElement('tr');
    const dt = r.data_simulacao || r.updated_at || r.created_at || '';
    tr.innerHTML = `
      <td>${formatDateBR(dt)}</td>
      <td>${r.cliente_nome || '—'}</td>
      <td>${r.cliente_telefone || '—'}</td>
      <td>${r.status || 'NOVO'}</td>
      <td>${r.cidade || '—'}</td>
      <td style="text-align:right">${formatBRL(r.total_estimado || 0)}</td>
      <td style="text-align:right">${formatBRL(r.valor_a_financiar || 0)}</td>
      <td style="white-space:nowrap"></td>
    `;

    const td = tr.querySelector('td:last-child');
    td.appendChild(rowBtn('Abrir no simulador', ()=>{
      setLeadToLoad(r);
      location.href = 'index.html';
    }));

    td.appendChild(rowBtn('Ver histórico', ()=>{
      renderHistory(r.lead_id);
    }));

    tbody.appendChild(tr);
  }

  wrap.appendChild(table);
  $('tableWrap').innerHTML = '';
  $('tableWrap').appendChild(wrap);
}

function renderHistory(leadId){
  const hist = ALL.filter(r => (r.lead_id || r.cliente_telefone || r.cliente_nome) === leadId)
    .sort((a,b)=> parseTS(b.updated_at || b.created_at || b.data_simulacao) - parseTS(a.updated_at || a.created_at || a.data_simulacao));

  const wrap = document.createElement('div');
  wrap.innerHTML = `<h3 style="margin:0 0 10px 0">Histórico do lead</h3>`;
  const table = document.createElement('table');
  table.className = 'table';
  table.style.width = '100%';
  table.innerHTML = `<tr><th>Data</th><th>Status</th><th>Total</th><th>Financia</th><th>Observações</th><th>Ação</th></tr>`;

  for(const r of hist){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${formatDateBR(r.data_simulacao || r.updated_at || r.created_at || '')}</td>
      <td>${r.status || '—'}</td>
      <td style="text-align:right">${formatBRL(r.total_estimado || 0)}</td>
      <td style="text-align:right">${formatBRL(r.valor_a_financiar || 0)}</td>
      <td>${(r.notes || '').slice(0,90)}</td>
      <td></td>
    `;
    const td = tr.querySelector('td:last-child');
    td.appendChild(rowBtn('Abrir', ()=>{
      setLeadToLoad(r);
      location.href = 'index.html';
    }));
    table.appendChild(tr);
  }

  wrap.appendChild(table);
  $('tableWrap').innerHTML = '';
  $('tableWrap').appendChild(wrap);
}

async function load(){
  const {token,user} = getSession();
  if(!token) return;

  try{
    // Se token já estava salvo e exige troca
    if(user && user.mustChangePassword){
      lockForPasswordChange();
      return;
    }

    const r = await listLeads(token);
    if(!r.ok) return showMsg($('msg2'), r.error || 'Erro ao listar leads', false);

    ALL = r.leads || [];
    LAST = computeLastByLead(ALL);

    renderTable(LAST);
    showMsg($('msg2'), `Leads carregados: ${LAST.length} (mostrando último por lead).`, true);
  }catch(e){
    showMsg($('msg2'), String(e), false);
  }
}

$('btnRefresh').onclick = load;
$('q').oninput = ()=> renderTable(LAST);
$('status').onchange = ()=> renderTable(LAST);

refreshMenu();

(async function boot(){
  const {token,user} = getSession();
  if(token){
    try{
      refreshMenu();
      if(user && user.mustChangePassword){
        lockForPasswordChange();
        return;
      }
      await load();
    }catch(_){
      doLogout();
    }
  }
})();
</script>
</body>
</html>
