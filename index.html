<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>JG | Proposta de Construção</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
<div class="container">

  <!-- LOGIN -->
  <div class="card no-print">
    <h1>JG | Proposta de Construção</h1>
    <div class="muted">Acesso exclusivo para corretores autorizados</div>
    <div class="hr"></div>

    <div class="row row-2">
      <div>
        <label>E-mail</label>
        <input id="email" type="email" autocomplete="username"/>
      </div>
      <div>
        <label>Senha</label>
        <input id="password" type="password" autocomplete="current-password"/>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <button class="btn" id="btnLogin">Entrar</button>
      <button class="btn secondary" id="btnLogout" style="display:none">Sair</button>
      <span class="badge" id="who"></span>
      <a class="btn secondary" id="crmLink" href="crm.html" style="display:none">CRM</a>
    </div>

    <div id="msg" style="margin-top:12px"></div>
  </div>

  <div class="grid grid-2" style="margin-top:16px">

    <!-- FORM -->
    <div class="card no-print">
      <h2>Dados do Cliente</h2>
      <div class="hr"></div>

      <div class="row row-2">
        <div>
          <label>Nome do cliente</label>
          <input id="cliente_nome" />
        </div>
        <div>
          <label>Telefone</label>
          <input id="cliente_telefone" />
        </div>
      </div>

      <div class="row row-2" style="margin-top:10px">
        <div>
          <label>Cidade</label>
          <select id="cidade">
            <option value="BOA_VISTA">Boa Vista</option>
            <option value="CANTA">Cantá</option>
            <option value="OUTRO">Outro</option>
          </select>
        </div>
        <div>
          <label>Tipo de financiamento</label>
          <select id="tipo_financiamento">
            <option value="MCMV">Minha Casa Minha Vida</option>
            <option value="OUTROS">SBPE / Outros</option>
          </select>
        </div>
      </div>

      <div class="row row-2" style="margin-top:10px">
        <div>
          <label>Operação</label>
          <select id="operacao">
            <option value="TERRENO_E_CONSTRUCAO" selected>Terreno + Construção</option>
            <option value="CONSTRUCAO_APENAS">Construção apenas</option>
          </select>
        </div>
        <div>
          <label>Terreno próprio?</label>
          <select id="terreno_proprio">
            <option value="SIM">Sim</option>
            <option value="NAO" selected>Não</option>
          </select>
        </div>
      </div>

      <div class="row row-2" style="margin-top:10px">
        <div id="wrap_valor_terreno">
          <label>Valor do terreno (R$)</label>
          <input id="valor_terreno" />
          <div class="muted" style="margin-top:6px;font-size:12px">
            Preencha quando for Terreno + Construção e o terreno não for próprio.
          </div>
        </div>
        <div>
          <label>Renda bruta familiar (R$)</label>
          <input id="renda_bruta_familiar" />
        </div>
      </div>

      <div class="hr"></div>

      <h2>Dados da Obra</h2>

      <div class="row row-3">
        <div>
          <label>Área construída (m²)</label>
          <input id="area_m2" />
        </div>
        <div>
          <label>Padrão</label>
          <select id="padrao">
            <option value="C">Tipo C</option>
            <option value="B">Tipo B</option>
            <option value="A" selected>Tipo A</option>
          </select>
        </div>
        <div>
          <label>Laje</label>
          <select id="laje">
            <option value="NAO">Não</option>
            <option value="SIM">Sim</option>
          </select>
        </div>
      </div>

      <div class="row row-3" style="margin-top:10px">
        <div>
          <label>Projeto</label>
          <select id="projeto">
            <option value="SEM_ESTRUTURAL" selected>Sem estrutural</option>
            <option value="COM_ESTRUTURAL">Com estrutural</option>
          </select>
        </div>
        <div>
          <label>Vistoria Caixa</label>
          <select id="vistoria_aplica">
            <option value="SIM" selected>Sim</option>
            <option value="NAO">Não</option>
          </select>
        </div>
        <div>
          <label>Valor financiado (opcional)</label>
          <input id="valor_financiado" placeholder="Se preencher Entrada/Subsídio/Por fora, pode deixar em branco"/>
        </div>
      </div>

      <div class="hr"></div>

      <h2>Simulador Caixa</h2>
      <div class="muted" style="margin-top:-6px;font-size:12px">
        Esses valores deduzem do total (Terreno + Construção) para chegar ao valor a financiar.
      </div>

      <div class="row row-3" style="margin-top:10px">
        <div>
          <label>Entrada (R$)</label>
          <input id="entrada" />
        </div>
        <div>
          <label>Subsídio (R$)</label>
          <input id="subsidio" />
        </div>
        <div>
          <label>Valor por fora (R$)</label>
          <input id="valor_por_fora" placeholder="Ex: 10.000 (quando total 230k e financia 220k)"/>
        </div>
      </div>

      <div class="hr"></div>

      <h2>Calçada (Boa Vista)</h2>
      <div class="muted" style="margin-top:-6px;font-size:12px">
        Aplicado apenas se a cidade for Boa Vista e o terreno não tiver calçada.
      </div>

      <div class="row row-2" style="margin-top:10px">
        <div>
          <label>Possui calçada?</label>
          <select id="possui_calcada">
            <option value="SIM" selected>Sim</option>
            <option value="NAO">Não</option>
          </select>
        </div>
        <div id="wrap_calcada_ml">
          <label>Metragem linear total (m)</label>
          <input id="calcada_metros_lineares" placeholder="Ex: 10 (frente) ou 35 (esquina total)"/>
        </div>
      </div>

      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" id="btnCalcular">Calcular</button>
        <button class="btn secondary" id="btnSalvar">Salvar Lead</button>
        <button class="btn secondary" id="btnPDF">Gerar PDF</button>
      </div>

      <div id="msg2" style="margin-top:12px"></div>
    </div>

    <!-- RESUMO / PDF -->
    <div class="card">
      <div class="print-area" id="printArea">

        <div style="display:flex;gap:16px;align-items:center">
          <img src="logo.png" style="height:70px;object-fit:contain"/>
          <div>
            <div style="font-weight:700;font-size:16px" id="c_nome">—</div>
            <div style="font-size:12px" id="c_dados">—</div>
            <div style="font-size:12px" id="c_contato">—</div>
          </div>
        </div>

        <div class="hr"></div>

        <div id="resHeader"></div>
        <div class="hr"></div>

        <div id="resBody"></div>

        <div class="hr"></div>

        <div style="font-size:16px">
          <b>Total geral (imóvel + custas):</b> <span id="resTotal">—</span>
        </div>

        <div class="hr"></div>

        <div style="font-size:12px">
          <b>Corretor:</b> <span id="b_nome">—</span> |
          <b>CRECI:</b> <span id="b_creci">—</span> |
          <b>Contato:</b> <span id="b_tel">—</span>
        </div>

        <div style="margin-top:12px;font-size:11px">
          Proposta válida por <span id="c_validade">—</span> dias.
        </div>

        <div style="margin-top:26px;text-align:center">
          ___________________________________<br/>
          <b id="c_assinatura_nome">—</b><br/>
          <span id="c_assinatura_cargo">—</span>
        </div>

      </div>
    </div>

  </div>
</div>

<script src="app.js"></script>
<script>
let CONFIG=null, COMPANY=null, BROKER=null;

function showMsg(el, txt, ok=true){
  el.innerHTML = '<div class="notice '+(ok?'ok':'err')+'">'+txt+'</div>';
}

function refreshUI(){
  const {token,user}=getSession();
  $('btnLogin').style.display = token ? 'none' : 'inline-flex';
  $('btnLogout').style.display = token ? 'inline-flex' : 'none';
  $('who').textContent = token ? (user.name+' ('+user.role+')') : '';
  $('crmLink').style.display = (token && user.role==='ADMIN') ? 'inline-flex' : 'none';
}

function toggleTerrenoUI(){
  const op = $('operacao').value;
  const tp = $('terreno_proprio').value;
  const show = (op === 'TERRENO_E_CONSTRUCAO' && tp !== 'SIM');
  $('wrap_valor_terreno').style.display = show ? 'block' : 'none';
  if(!show) $('valor_terreno').value = '0';
}

function toggleCalcadaUI(){
  const city = $('cidade').value;
  const pc = $('possui_calcada').value;
  const show = (city === 'BOA_VISTA' && pc === 'NAO');
  $('wrap_calcada_ml').style.display = show ? 'block' : 'none';
  if(!show) $('calcada_metros_lineares').value = '';
}

function renderCompanyBroker(){
  if(COMPANY){
    $('c_nome').textContent = COMPANY.nome_fantasia || '—';
    $('c_dados').textContent = (COMPANY.razao_social || '—') + ' | CNPJ ' + (COMPANY.cnpj || '—');
    $('c_contato').textContent = (COMPANY.endereco || '') + (COMPANY.telefone ? (' | '+COMPANY.telefone) : '') + (COMPANY.email ? (' | '+COMPANY.email) : '');
    $('c_validade').textContent = COMPANY.validade_proposta_dias || '—';
    $('c_assinatura_nome').textContent = COMPANY.assinatura_nome || '—';
    $('c_assinatura_cargo').textContent = COMPANY.assinatura_cargo || '—';
  }
  if(BROKER){
    $('b_nome').textContent = BROKER.nome_completo || BROKER.apelido || '—';
    $('b_creci').textContent = BROKER.creci || '—';
    $('b_tel').textContent = BROKER.telefone || '—';
  }
}

function readPayload(){
  return {
    cliente_nome: $('cliente_nome').value,
    cliente_telefone: $('cliente_telefone').value,

    cidade: $('cidade').value,
    tipo_financiamento: $('tipo_financiamento').value,

    operacao: $('operacao').value,
    terreno_proprio: $('terreno_proprio').value,
    valor_terreno: $('valor_terreno').value,
    renda_bruta_familiar: $('renda_bruta_familiar').value,

    area_m2: $('area_m2').value,
    padrao: $('padrao').value,
    laje: $('laje').value,

    projeto: $('projeto').value,
    vistoria_aplica: $('vistoria_aplica').value,

    // opcional
    valor_financiado: $('valor_financiado').value,

    // simulador
    entrada: $('entrada').value,
    subsidio: $('subsidio').value,
    valor_por_fora: $('valor_por_fora').value,

    // calcada
    possui_calcada: $('possui_calcada').value,
    calcada_metros_lineares: $('calcada_metros_lineares').value
  };
}

function renderReport(payload, calc){
  $('resHeader').innerHTML = `
    <div style="font-size:13px">
      <b>Cliente:</b> ${payload.cliente_nome || '—'} | ${payload.cliente_telefone || '—'}<br/>
      <b>Cidade:</b> ${payload.cidade} |
      <b>Financiamento:</b> ${payload.tipo_financiamento} |
      <b>Área:</b> ${payload.area_m2 || '—'} m² |
      <b>Padrão:</b> ${payload.padrao} |
      <b>Operação:</b> ${payload.operacao} |
      <b>Terreno próprio:</b> ${payload.terreno_proprio}
    </div>
  `;

  const boxStyle = "padding:10px;border:1px solid #ddd;border-radius:12px;margin:10px 0;";
  const strongStyle = "font-size:15px;font-weight:700;";

  const terrenoEntra = (payload.terreno_proprio !== 'SIM' && payload.operacao === 'TERRENO_E_CONSTRUCAO');

  const resumoImovel = `
    <div style="${boxStyle}">
      <div style="${strongStyle}">Resumo do Imóvel</div>
      <div><b>Valor da Obra:</b> ${formatBRL(calc.valorObra)}</div>
      ${terrenoEntra ? `<div><b>Valor do Terreno:</b> ${formatBRL(calc.valorTerrenoCalc)}</div>` : ``}
      <div style="margin-top:6px"><b>Total (Terreno + Construção):</b> ${formatBRL(calc.totalTerrenoConstrucao)}</div>
    </div>
  `;

  const finBox = `
    <div style="${boxStyle}">
      <div style="${strongStyle}">Composição do Financiamento</div>
      <div><b>Total (Terreno + Construção):</b> ${formatBRL(calc.totalTerrenoConstrucao)}</div>
      <div><b>Entrada:</b> ${formatBRL(calc.entrada)}</div>
      <div><b>Subsídio:</b> ${formatBRL(calc.subsidio)}</div>
      <div><b>Valor por fora:</b> ${formatBRL(calc.porFora)}</div>
      <div style="margin-top:8px"><b>Valor a financiar (calculado):</b> ${formatBRL(calc.valorAFinanciar)}</div>
      <div class="muted" style="font-size:12px;margin-top:6px">
        Fórmula: Total − Entrada − Subsídio − Por fora
      </div>
    </div>
  `;

  const showProjSem = (calc.projSem > 0);
  const showProjCom = (calc.projCom > 0);
  const showCno = (calc.area > 70 && calc.cno > 0);

  // Ordem exatamente como você pediu:
  // Construção, Laje, Projeto (um ou outro), CREA, Alvará (m²×tarifa), Vistoria, Taxa financiamento,
  // ITBI, Registro alienação, TAO, Calçada, Habite-se (m²×tarifa), CNO (>70, após Habite-se), Averbação
  const custos = `
    <table class="table">
      <tr><td>Construção base</td><td style="text-align:right">${formatBRL(calc.custoBase)}</td></tr>
      <tr><td>Laje</td><td style="text-align:right">${formatBRL(calc.laje)}</td></tr>

      ${showProjSem ? `<tr><td>Projeto (sem estrutural)</td><td style="text-align:right">${formatBRL(calc.projSem)}</td></tr>` : ``}
      ${showProjCom ? `<tr><td>Projeto (com estrutural)</td><td style="text-align:right">${formatBRL(calc.projCom)}</td></tr>` : ``}

      <tr><td>ART's do CREA</td><td style="text-align:right">${formatBRL(calc.crea)}</td></tr>

      <tr><td>Alvará de Construção</td><td style="text-align:right">${formatBRL(calc.alvara)}</td></tr>

      <tr><td>Vistoria Caixa</td><td style="text-align:right">${formatBRL(calc.vistoria)}</td></tr>

      <tr><td>Taxa de financiamento</td><td style="text-align:right">${formatBRL(calc.taxaFinR)}</td></tr>

      <tr><td>ITBI (terreno)</td><td style="text-align:right">${formatBRL(calc.itbi)}</td></tr>

      <tr><td>Registro de Alienação</td><td style="text-align:right">${formatBRL(calc.regAlienacao)}</td></tr>

      <tr><td>TAO</td><td style="text-align:right">${formatBRL(calc.tao)}</td></tr>

      <tr><td>Calçada</td><td style="text-align:right">${formatBRL(calc.calcada)}</td></tr>

      <tr><td>Habite-se</td><td style="text-align:right">${formatBRL(calc.habite)}</td></tr>

      ${showCno ? `<tr><td>CNO (Receita Federal)</td><td style="text-align:right">${formatBRL(calc.cno)}</td></tr>` : ``}

      <tr><td>Averbação da Obra</td><td style="text-align:right">${formatBRL(calc.averbacao)}</td></tr>
    </table>
  `;

  $('resBody').innerHTML = `
    ${resumoImovel}
    ${finBox}
    ${custos}
  `;

  $('resTotal').textContent = formatBRL(calc.totalGeral);
}

async function loadAfterLogin(token){
  const cfg = await getConfig(token);
  if(!cfg.ok) throw new Error(cfg.error || 'Erro ao carregar Config');
  CONFIG = cfg.config;

  const ft = await getFeeTables(token);
  if(ft.ok) FEE_TABLES = ft.tables;

  const c = await getCompany(token);
  if(c.ok) COMPANY = c.company;

  const b = await getBroker(token);
  if(b.ok) BROKER = b.broker;

  renderCompanyBroker();
}

$('btnLogin').onclick = async ()=>{
  try{
    const r = await apiPost({action:'login', email:$('email').value, password:$('password').value});
    if(!r.ok) return showMsg($('msg'), r.error || 'Erro no login', false);

    setSession(r.token, r.user);
    refreshUI();

    await loadAfterLogin(r.token);
    showMsg($('msg'), 'Login realizado e configurações carregadas.', true);
  } catch(e){
    showMsg($('msg'), String(e), false);
  }
};

$('btnLogout').onclick = ()=>{
  clearSession();
  CONFIG=null; COMPANY=null; BROKER=null; FEE_TABLES=null;
  refreshUI();
  showMsg($('msg'), 'Sessão encerrada.', true);
};

$('btnCalcular').onclick = ()=>{
  const {token} = getSession();
  if(!token) return showMsg($('msg2'), 'Faça login primeiro.', false);
  if(!CONFIG) return showMsg($('msg2'), 'Config não carregada. Saia e faça login novamente.', false);

  const payload = readPayload();
  const calc = calcTotal(payload, CONFIG);
  renderReport(payload, calc);
  showMsg($('msg2'), 'Cálculo atualizado.', true);
};

$('btnSalvar').onclick = async ()=>{
  const {token} = getSession();
  if(!token) return showMsg($('msg2'), 'Faça login primeiro.', false);
  if(!CONFIG) return showMsg($('msg2'), 'Config não carregada. Saia e faça login novamente.', false);

  const payload = readPayload();
  const calc = calcTotal(payload, CONFIG);

  payload.total_estimado = calc.totalGeral;
  payload.valor_a_financiar = calc.valorAFinanciar;

  // CRM defaults (se quiser)
  payload.status = payload.status || 'NOVO';
  payload.next_action_at = payload.next_action_at || '';
  payload.notes = payload.notes || '';

  const r = await apiPost({action:'saveLead', token, payload});
  showMsg($('msg2'), r.ok ? 'Lead salvo com sucesso.' : (r.error || 'Erro ao salvar'), !!r.ok);
};

$('btnPDF').onclick = ()=> window.print();

// listeners
$('operacao').onchange = toggleTerrenoUI;
$('terreno_proprio').onchange = toggleTerrenoUI;
$('cidade').onchange = toggleCalcadaUI;
$('possui_calcada').onchange = toggleCalcadaUI;

// init
refreshUI();
toggleTerrenoUI();
toggleCalcadaUI();
</script>
</body>
</html>
