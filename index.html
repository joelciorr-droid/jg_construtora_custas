<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>JG | Proposta & Custas</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <div class="container">
    <div class="card no-print">
      <h1>JG | Proposta & Custas</h1>
      <div class="muted">Acesso do corretor (login) — seus cálculos ficam protegidos.</div>
      <div class="hr"></div>

      <div class="row row-2">
        <div>
          <label>E-mail</label>
          <input id="email" type="email" placeholder="corretor@..." />
        </div>
        <div>
          <label>Senha</label>
          <input id="password" type="password" placeholder="********" />
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" id="btnLogin">Entrar</button>
        <button class="btn secondary" id="btnLogout" style="display:none">Sair</button>
        <span class="badge" id="who"></span>
      </div>

      <div id="msg" style="margin-top:12px"></div>
    </div>

    <div class="grid grid-2" style="margin-top:16px">
      <div class="card no-print">
        <h2>Dados do cliente</h2>
        <div class="muted">Esses dados são gravados para acompanhamento do funil.</div>
        <div class="hr"></div>

        <div class="row row-2">
          <div>
            <label>Nome do cliente</label>
            <input id="cliente_nome" />
          </div>
          <div>
            <label>Telefone (WhatsApp)</label>
            <input id="cliente_telefone" placeholder="(95) 9xxxx-xxxx"/>
          </div>
        </div>

        <div class="row row-2" style="margin-top:10px">
          <div>
            <label>Cidade (obra)</label>
            <select id="cidade">
              <option value="BOA_VISTA">Boa Vista</option>
              <option value="CANTA">Cantá</option>
              <option value="OUTRO">Outro</option>
            </select>
          </div>
          <div>
            <label>Operação</label>
            <select id="operacao">
              <option value="TERRENO_E_CONSTRUCAO">Terreno + Construção</option>
              <option value="CONSTRUCAO_APENAS">Construção apenas</option>
            </select>
          </div>
        </div>

        <div class="row row-2" style="margin-top:10px">
          <div>
            <label>Tipo financiamento</label>
            <select id="tipo_financiamento">
              <option value="MCMV">Minha Casa Minha Vida</option>
              <option value="OUTROS">SBPE / Outros</option>
            </select>
          </div>
          <div>
            <label>Renda bruta familiar (R$) (para ITBI Boa Vista)</label>
            <input id="renda_bruta_familiar" placeholder="Ex: 4500,00"/>
          </div>
        </div>

        <div class="hr"></div>

        <h2>Dados da obra</h2>

        <div class="row row-3">
          <div>
            <label>Área construída (m²)</label>
            <input id="area_m2" placeholder="Ex: 72"/>
          </div>
          <div>
            <label>Padrão</label>
            <select id="padrao">
              <option value="C">Tipo C (básico)</option>
              <option value="B">Tipo B (intermediário)</option>
              <option value="A" selected>Tipo A (normal)</option>
            </select>
          </div>
          <div>
            <label>Laje?</label>
            <select id="laje">
              <option value="NAO">Não</option>
              <option value="SIM">Sim</option>
            </select>
          </div>
        </div>

        <div class="row row-3" style="margin-top:10px">
          <div>
            <label>Valor do terreno (R$)</label>
            <input id="valor_terreno" placeholder="Ex: 60000,00"/>
          </div>
          <div>
            <label>Valor financiado (R$)</label>
            <input id="valor_financiado" placeholder="Ex: 210000,00"/>
          </div>
          <div>
            <label>Projeto</label>
            <select id="projeto">
              <option value="SEM_ESTRUTURAL">Sem estrutural</option>
              <option value="COM_ESTRUTURAL">Com estrutural</option>
            </select>
          </div>
        </div>

        <div class="row row-3" style="margin-top:10px">
          <div>
            <label>Possui calçada?</label>
            <select id="possui_calcada">
              <option value="SIM">Sim</option>
              <option value="NAO">Não</option>
            </select>
          </div>
          <div>
            <label>Metros lineares de calçada</label>
            <input id="calcada_metros_lineares" placeholder="Ex: 10"/>
          </div>
          <div></div>
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn" id="btnCalcular">Calcular</button>
          <button class="btn secondary" id="btnSalvar">Salvar lead</button>
          <button class="btn secondary" id="btnPDF">Gerar PDF</button>
          <a class="btn secondary" id="adminLink" href="admin.html" style="display:none">Admin</a>
        </div>

        <div id="msg2" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <div class="no-print">
          <h2>Resumo (para apresentar ao cliente)</h2>
          <div class="muted">Este bloco é o que vai para o PDF.</div>
          <div class="hr"></div>
        </div>

        <div class="print-area" id="printArea">
          <h2 style="margin-top:0">Proposta de Custas e Construção</h2>
          <div id="resHeader" class="muted"></div>
          <div class="hr"></div>
          <div id="resBody"></div>
          <div class="hr"></div>
          <div><b>Total estimado:</b> <span id="resTotal"></span></div>
          <div style="margin-top:10px;font-size:12px;color:#333">
            Observação: valores estimados com base nas configurações vigentes e informações fornecidas pelo cliente.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    let CONFIG = null;

    function msg(el, html, ok=true){
      el.innerHTML = '<div class="notice ' + (ok?'ok':'err') + '">' + html + '</div>';
    }

    async function loadConfig(){
      const { token } = getSession();
      if (!token) return;
      const r = await apiPost({ action:'getConfig', token });
      if (r.ok){
        CONFIG = r.config;
      }
    }

    function collectPayload(){
      return {
        cliente_nome: $('cliente_nome').value.trim(),
        cliente_telefone: $('cliente_telefone').value.trim(),
        cidade: $('cidade').value,
        operacao: $('operacao').value,
        tipo_financiamento: $('tipo_financiamento').value,
        renda_bruta_familiar: $('renda_bruta_familiar').value,
        area_m2: $('area_m2').value,
        padrao: $('padrao').value,
        laje: $('laje').value,
        valor_terreno: $('valor_terreno').value,
        valor_financiado: $('valor_financiado').value,
        projeto: $('projeto').value,
        possui_calcada: $('possui_calcada').value,
        calcada_metros_lineares: $('calcada_metros_lineares').value
      };
    }

    function renderResumo(payload, calc){
      const padraoTxt = payload.padrao === 'A' ? 'Tipo A (normal)' : payload.padrao === 'B' ? 'Tipo B (intermediário)' : 'Tipo C (básico)';
      $('resHeader').innerHTML =
        `<div><b>Cliente:</b> ${payload.cliente_nome || '-'} | <b>Telefone:</b> ${payload.cliente_telefone || '-'}</div>
         <div><b>Cidade:</b> ${payload.cidade} | <b>Financiamento:</b> ${payload.tipo_financiamento} | <b>Padrão:</b> ${padraoTxt}</div>
         <div><b>Área:</b> ${payload.area_m2 || 0} m² | <b>Valor financiado:</b> ${formatBRL(payload.valor_financiado)} | <b>Terreno:</b> ${formatBRL(payload.valor_terreno)}</div>`;

      const linhas = [
        ['Construção (base)', calc.custoBase],
        ['Laje (adicional)', calc.laje],
        ['Projeto', calc.projSem + calc.projCom],
        ['Taxa financiamento', calc.taxaFinR],
        ['ITBI (terreno)', calc.itbi],
        ['Vistoria CAIXA', calc.vistoria],
        ['TAO', calc.tao],
        ['Calçada', calc.calcada],
      ].filter(x => Number(x[1]) > 0);

      $('resBody').innerHTML = `
        <table class="table" style="width:100%">
          <thead><tr><th>Item</th><th style="text-align:right">Valor</th></tr></thead>
          <tbody>
            ${linhas.map(l => `<tr><td>${l[0]}</td><td style="text-align:right">${formatBRL(l[1])}</td></tr>`).join('')}
          </tbody>
        </table>
      `;

      $('resTotal').textContent = formatBRL(calc.total);
    }

    function refreshUI(){
      const { token, user } = getSession();
      $('btnLogin').style.display = token ? 'none' : 'inline-flex';
      $('btnLogout').style.display = token ? 'inline-flex' : 'none';
      $('who').textContent = token ? `${user.name} (${user.role})` : '';
      $('adminLink').style.display = token && user.role === 'ADMIN' ? 'inline-flex' : 'none';
    }

    $('btnLogin').onclick = async () => {
      try{
        const email = $('email').value.trim();
        const password = $('password').value;
        const r = await apiPost({ action:'login', email, password });
        if (!r.ok) return msg($('msg'), r.error, false);
        setSession(r.token, r.user);
        msg($('msg'), 'Login ok!', true);
        refreshUI();
        await loadConfig();
      }catch(e){
        msg($('msg'), String(e), false);
      }
    };

    $('btnLogout').onclick = () => {
      clearSession();
      refreshUI();
      msg($('msg'), 'Sessão encerrada.', true);
    };

    $('btnCalcular').onclick = async () => {
      try{
        const { token } = getSession();
        if (!token) return msg($('msg2'), 'Faça login primeiro.', false);
        if (!CONFIG) await loadConfig();
        const payload = collectPayload();
        const calc = calcTotal(payload, CONFIG);
        payload.total_estimado = calc.total;
        renderResumo(payload, calc);
        msg($('msg2'), 'Cálculo atualizado.', true);
      }catch(e){
        msg($('msg2'), String(e), false);
      }
    };

    $('btnSalvar').onclick = async () => {
      try{
        const { token } = getSession();
        if (!token) return msg($('msg2'), 'Faça login primeiro.', false);
        if (!CONFIG) await loadConfig();
        const payload = collectPayload();
        const calc = calcTotal(payload, CONFIG);
        payload.total_estimado = calc.total;

        const r = await apiPost({ action:'saveLead', token, payload });
        if (!r.ok) return msg($('msg2'), r.error, false);
        msg($('msg2'), 'Lead salvo no Google Sheets.', true);
      }catch(e){
        msg($('msg2'), String(e), false);
      }
    };

    $('btnPDF').onclick = () => {
      // PDF nativo do navegador
      window.print();
    };

    // init
    (async function(){
      refreshUI();
      const { token } = getSession();
      if (token) await loadConfig();
    })();
  </script>
</body>
</html>
