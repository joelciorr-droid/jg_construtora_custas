<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>JG | Proposta de Construção</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
<div class="container">

  <!-- LOGIN -->
  <div class="card no-print">
    <h1>JG | Proposta de Construção</h1>
    <div class="muted">Acesso exclusivo para corretores autorizados</div>
    <div class="hr"></div>

    <div class="row row-2">
      <div>
        <label>E-mail</label>
        <input id="email" type="email"/>
      </div>
      <div>
        <label>Senha</label>
        <input id="password" type="password"/>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnLogin">Entrar</button>
      <button class="btn secondary" id="btnLogout" style="display:none">Sair</button>
      <span class="badge" id="who"></span>
      <a class="btn secondary" id="crmLink" href="crm.html" style="display:none">CRM</a>
    </div>

    <div id="msg" style="margin-top:12px"></div>
  </div>

  <!-- FORM + RESUMO -->
  <div class="grid grid-2" style="margin-top:16px">

    <!-- FORM -->
    <div class="card no-print">
      <h2>Dados do Cliente</h2>
      <div class="hr"></div>

      <div class="row row-2">
        <div>
          <label>Nome do cliente</label>
          <input id="cliente_nome"/>
        </div>
        <div>
          <label>Telefone</label>
          <input id="cliente_telefone"/>
        </div>
      </div>

      <div class="row row-2" style="margin-top:10px">
        <div>
          <label>Cidade</label>
          <select id="cidade">
            <option value="BOA_VISTA">Boa Vista</option>
            <option value="CANTA">Cantá</option>
            <option value="OUTRO">Outro</option>
          </select>
        </div>
        <div>
          <label>Operação</label>
          <select id="operacao">
            <option value="TERRENO_E_CONSTRUCAO">Terreno + Construção</option>
            <option value="CONSTRUCAO_APENAS">Construção apenas</option>
          </select>
        </div>
      </div>

      <div class="row row-2" style="margin-top:10px">
        <div>
          <label>Tipo de financiamento</label>
          <select id="tipo_financiamento">
            <option value="MCMV">Minha Casa Minha Vida</option>
            <option value="OUTROS">SBPE / Outros</option>
          </select>
        </div>
        <div>
          <label>Renda bruta familiar (R$)</label>
          <input id="renda_bruta_familiar"/>
        </div>
      </div>

      <div class="hr"></div>

      <h2>Dados da Obra</h2>

      <div class="row row-3">
        <div>
          <label>Área construída (m²)</label>
          <input id="area_m2"/>
        </div>
        <div>
          <label>Padrão</label>
          <select id="padrao">
            <option value="C">Tipo C</option>
            <option value="B">Tipo B</option>
            <option value="A" selected>Tipo A</option>
          </select>
        </div>
        <div>
          <label>Laje</label>
          <select id="laje">
            <option value="NAO">Não</option>
            <option value="SIM">Sim</option>
          </select>
        </div>
      </div>

      <div class="row row-3" style="margin-top:10px">
        <div>
          <label>Valor do terreno</label>
          <input id="valor_terreno"/>
        </div>
        <div>
          <label>Valor financiado</label>
          <input id="valor_financiado"/>
        </div>
        <div>
          <label>Projeto</label>
          <select id="projeto">
            <option value="SEM_ESTRUTURAL">Sem estrutural</option>
            <option value="COM_ESTRUTURAL">Com estrutural</option>
          </select>
        </div>
      </div>

      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" id="btnCalcular">Calcular</button>
        <button class="btn secondary" id="btnSalvar">Salvar Lead</button>
        <button class="btn secondary" id="btnPDF">Gerar PDF</button>
      </div>

      <div id="msg2" style="margin-top:12px"></div>
    </div>

    <!-- RESUMO / PDF -->
    <div class="card">
      <div class="print-area" id="printArea">

        <div style="display:flex;gap:16px;align-items:center">
          <img src="logo.png" style="height:70px"/>
          <div>
            <div style="font-weight:700;font-size:16px" id="c_nome"></div>
            <div style="font-size:12px" id="c_dados"></div>
          </div>
        </div>

        <div class="hr"></div>

        <div id="resHeader"></div>
        <div class="hr"></div>
        <div id="resBody"></div>

        <div class="hr"></div>
        <div style="font-size:16px"><b>Total estimado:</b> <span id="resTotal"></span></div>

        <div class="hr"></div>

        <div style="font-size:12px">
          <b>Corretor:</b> <span id="b_nome"></span> |
          <b>CRECI:</b> <span id="b_creci"></span> |
          <b>Contato:</b> <span id="b_tel"></span>
        </div>

        <div style="margin-top:12px;font-size:11px">
          Proposta válida por <span id="c_validade"></span> dias.
        </div>

        <div style="margin-top:30px;text-align:center">
          ___________________________________<br/>
          <b id="c_assinatura_nome"></b><br/>
          <span id="c_assinatura_cargo"></span>
        </div>

      </div>
    </div>

  </div>
</div>

<script src="app.js"></script>
<script>
let CONFIG=null, COMPANY=null, BROKER=null;

function msg(el, txt, ok=true){
  el.innerHTML='<div class="notice '+(ok?'ok':'err')+'">'+txt+'</div>';
}

function refreshUI(){
  const {token,user}=getSession();
  $('btnLogin').style.display=token?'none':'inline-flex';
  $('btnLogout').style.display=token?'inline-flex':'none';
  $('who').textContent=token?user.name+' ('+user.role+')':'';
  $('crmLink').style.display=(token && user.role==='ADMIN')?'inline-flex':'none';
}

async function loadExtras(){
  const {token}=getSession();
  const c=await getCompany(token); if(c.ok) COMPANY=c.company;
  const b=await getBroker(token); if(b.ok) BROKER=b.broker;
}

$('btnLogin').onclick=async()=>{
  const r=await apiPost({action:'login',email:$('email').value,password:$('password').value});
  if(!r.ok) return msg($('msg'),r.error,false);
  setSession(r.token,r.user);
  refreshUI();
  const cfg = await getConfig(r.token);
  if(!cfg.ok) return msg($('msg'),'Erro ao carregar configurações.',false);
  CONFIG = cfg.config;
  
  const ft = await getFeeTables(r.token);
  if(ft.ok) FEE_TABLES = ft.tables;
  
  await loadExtras();
  msg($('msg'),'Login realizado.',true);
};

$('btnLogout').onclick=()=>{
  clearSession(); refreshUI();
};

$('btnCalcular').onclick=()=>{
  const { token } = getSession();
  if(!token) return msg($('msg2'),'Faça login primeiro.',false);
  if(!CONFIG) return msg($('msg2'),'Config não carregada. Refaça o login.',false);
  const payload={
    cliente_nome:$('cliente_nome').value,
    cliente_telefone:$('cliente_telefone').value,
    cidade:$('cidade').value,
    operacao:$('operacao').value,
    tipo_financiamento:$('tipo_financiamento').value,
    renda_bruta_familiar:$('renda_bruta_familiar').value,
    area_m2:$('area_m2').value,
    padrao:$('padrao').value,
    laje:$('laje').value,
    valor_terreno:$('valor_terreno').value,
    valor_financiado:$('valor_financiado').value,
    projeto:$('projeto').value
  };

  const calc=calcTotal(payload,CONFIG);
  $('resHeader').innerHTML=`<b>Cliente:</b> ${payload.cliente_nome} | ${payload.cliente_telefone}`;
  $('resBody').innerHTML=`
  <table class="table">
    <tr><td>Construção base</td><td style="text-align:right">${formatBRL(calc.custoBase)}</td></tr>
    <tr><td>Projetos</td><td style="text-align:right">${formatBRL(calc.projSem+calc.projCom)}</td></tr>
    <tr><td>Taxa financiamento</td><td style="text-align:right">${formatBRL(calc.taxaFinR)}</td></tr>
    <tr><td>ITBI</td><td style="text-align:right">${formatBRL(calc.itbi)}</td></tr>
    <tr><td>Vistoria Caixa</td><td style="text-align:right">${formatBRL(calc.vistoria)}</td></tr>
    <tr><td>TAO</td><td style="text-align:right">${formatBRL(calc.tao)}</td></tr>
    <tr><td>Calçada</td><td style="text-align:right">${formatBRL(calc.calcada)}</td></tr>

    <tr><td>CREA (faixa por m²)</td><td style="text-align:right">${formatBRL(calc.crea)}</td></tr>
    <tr><td>Alvará (faixa por m²)</td><td style="text-align:right">${formatBRL(calc.alvara)}</td></tr>
    <tr><td>Habite-se (faixa por m²)</td><td style="text-align:right">${formatBRL(calc.habite)}</td></tr>
    <tr><td>Registro Alienação (faixa por R$)</td><td style="text-align:right">${formatBRL(calc.regAlienacao)}</td></tr>
    <tr><td>Averbação (faixa por R$)</td><td style="text-align:right">${formatBRL(calc.averbacao)}</td></tr>
    <tr><td>CNO (receita)</td><td style="text-align:right">${formatBRL(calc.cno)}</td></tr>
  </table>`;
  $('resTotal').textContent=formatBRL(calc.total);

  if(COMPANY){
    $('c_nome').textContent=COMPANY.nome_fantasia;
    $('c_dados').textContent=COMPANY.razao_social+' | CNPJ '+COMPANY.cnpj;
    $('c_validade').textContent=COMPANY.validade_proposta_dias;
    $('c_assinatura_nome').textContent=COMPANY.assinatura_nome;
    $('c_assinatura_cargo').textContent=COMPANY.assinatura_cargo;
  }
  if(BROKER){
    $('b_nome').textContent=BROKER.nome_completo||BROKER.apelido;
    $('b_creci').textContent=BROKER.creci;
    $('b_tel').textContent=BROKER.telefone;
  }
};

$('btnSalvar').onclick=async()=>{
  const {token}=getSession();
  const payload={cliente_nome:$('cliente_nome').value,cliente_telefone:$('cliente_telefone').value};
  const r=await apiPost({action:'saveLead',token,payload});
  msg($('msg2'),r.ok?'Lead salvo.':r.error,r.ok);
};

$('btnPDF').onclick=()=>window.print();

refreshUI();
</script>
</body>
</html>



