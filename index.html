<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>JG | Simulador</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
<div class="container">

  <div class="card no-print" style="display:flex;gap:10px;align-items:center;justify-content:space-between">
    <div style="display:flex;gap:10px;align-items:center">
      <b>JG | Simulador</b>
      <span class="badge" id="whoMini"></span>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <a class="btn secondary" href="index.html">Simulador</a>
      <a class="btn secondary" id="crmLinkTop" href="crm.html" style="display:none">CRM</a>
      <a class="btn secondary" id="adminLinkTop" href="admin.html" style="display:none">Admin/Config</a>
      <button class="btn secondary" id="btnLogoutTop" style="display:none">Sair</button>
    </div>
  </div>

  <div class="card no-print" id="loginCard">
    <h1>JG | Proposta</h1>
    <div class="muted">Acesso exclusivo para corretores autorizados</div>
    <div class="hr"></div>

    <div class="row row-2">
      <div>
        <label>E-mail</label>
        <input id="email" type="email" autocomplete="username"/>
      </div>
      <div>
        <label>Senha</label>
        <input id="password" type="password" autocomplete="current-password"/>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <button class="btn" id="btnLogin">Entrar</button>
      <button class="btn secondary" id="btnLogout" style="display:none">Sair</button>
      <span class="badge" id="who"></span>
    </div>

    <div id="msg" style="margin-top:12px"></div>
  </div>

  <div class="card no-print" id="changePassCard" style="display:none">
    <h2>Troca de senha obrigatória</h2>
    <div class="muted">Defina sua nova senha para continuar.</div>
    <div class="hr"></div>

    <div class="row row-2">
      <div>
        <label>Nova senha</label>
        <input id="newPass" type="password" autocomplete="new-password"/>
      </div>
      <div>
        <label>Confirmar nova senha</label>
        <input id="newPass2" type="password" autocomplete="new-password"/>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnChangePass">Salvar nova senha</button>
      <button class="btn secondary" id="btnChangePassLogout">Sair</button>
    </div>

    <div id="msgPass" style="margin-top:12px"></div>
  </div>

  <div class="grid grid-2" id="appGrid" style="margin-top:16px">

    <div class="card no-print">
      <h2>Dados do Cliente</h2>
      <div class="hr"></div>

      <div class="row row-2">
        <div>
          <label>Nome do cliente</label>
          <input id="cliente_nome" />
        </div>
        <div>
          <label>Telefone</label>
          <input id="cliente_telefone" />
        </div>
      </div>

      <div class="row row-3" style="margin-top:10px">
        <div>
          <label>Data da simulação</label>
          <input id="data_simulacao" type="date"/>
        </div>
        <div>
          <label>Validade (dias)</label>
          <input id="validade_dias" placeholder="Ex: 7"/>
          <div class="muted" style="font-size:12px;margin-top:6px">Se vazio, usa o padrão da configuração.</div>
        </div>
        <div>
          <label>Tipo (Banco / Próprio)</label>
          <select id="tipo_financiamento">
            <option value="MCMV">Minha Casa Minha Vida</option>
            <option value="OUTROS">SBPE / Outros</option>
            <option value="PROPRIO">Recursos próprios</option>
          </select>
        </div>
      </div>

      <div class="row row-3" style="margin-top:10px">
        <div>
          <label>Tipo de simulação</label>
          <select id="tipo_simulacao">
            <option value="CONSTRUCAO" selected>Construção</option>
            <option value="VENDA">Venda de imóvel (novo/usado)</option>
          </select>
        </div>
        <div>
          <label>Cidade</label>
          <select id="cidade">
            <option value="BOA_VISTA">Boa Vista</option>
            <option value="CANTA">Cantá</option>
            <option value="OUTRO">Outro</option>
          </select>
        </div>
        <div id="wrap_primeiro_imovel" style="display:none">
          <label>Primeiro imóvel? (Boa Vista)</label>
          <select id="primeiro_imovel">
            <option value="SIM">Sim</option>
            <option value="NAO" selected>Não</option>
          </select>
        </div>
      </div>

      <div class="row row-2" style="margin-top:10px" id="wrap_renda">
        <div>
          <label>Renda bruta familiar (R$)</label>
          <input id="renda_bruta_familiar" />
        </div>
        <div class="muted" style="font-size:12px;align-self:end">
          Usado para ITBI/isenção em Boa Vista conforme regra configurada.
        </div>
      </div>

      <div class="hr"></div>

      <!-- VENDA IMÓVEL -->
      <div id="secVenda" style="display:none">
        <h2>Dados do Imóvel (Venda)</h2>

        <div class="row row-2" style="margin-top:10px">
          <div>
            <label>Imóvel</label>
            <select id="tipo_imovel">
              <option value="NOVO" selected>Casa nova</option>
              <option value="USADO">Casa usada</option>
            </select>
          </div>
          <div>
            <label>Valor total do imóvel (R$)</label>
            <input id="valor_imovel" placeholder="Ex: 450.000"/>
          </div>
        </div>

        <div class="hr"></div>
      </div>

      <!-- CONSTRUÇÃO -->
      <div id="secConstrucao">
        <h2>Dados da Obra (Construção)</h2>

        <div class="row row-3">
          <div>
            <label>Operação</label>
            <select id="operacao">
              <option value="TERRENO_E_CONSTRUCAO" selected>Terreno + Construção</option>
              <option value="CONSTRUCAO_APENAS">Construção apenas</option>
            </select>
          </div>
          <div>
            <label>Terreno próprio?</label>
            <select id="terreno_proprio">
              <option value="SIM">Sim</option>
              <option value="NAO" selected>Não</option>
            </select>
          </div>
          <div id="wrap_valor_terreno">
            <label>Valor do terreno (R$)</label>
            <input id="valor_terreno" />
          </div>
        </div>

        <div class="row row-3" style="margin-top:10px">
          <div>
            <label>Área construída (m²)</label>
            <input id="area_m2" />
          </div>
          <div>
            <label>Padrão</label>
            <select id="padrao">
              <option value="C">Tipo C</option>
              <option value="B">Tipo B</option>
              <option value="A" selected>Tipo A</option>
            </select>
          </div>
          <div>
            <label>Laje</label>
            <select id="laje">
              <option value="NAO" selected>Não</option>
              <option value="SIM">Sim</option>
            </select>
            <div class="muted" style="font-size:12px;margin-top:6px">Sem laje: projeto sem estrutural. Com laje: projeto com estrutural.</div>
          </div>
        </div>

        <div class="hr"></div>

        <h2>Calçada (Boa Vista)</h2>

        <div class="row row-2" style="margin-top:10px">
          <div>
            <label>Possui calçada?</label>
            <select id="possui_calcada">
              <option value="SIM" selected>Sim</option>
              <option value="NAO">Não</option>
            </select>
          </div>
          <div id="wrap_calcada_ml">
            <label>Metragem linear total (m)</label>
            <input id="calcada_metros_lineares" placeholder="Ex: 10 (frente) ou 35 (esquina total)"/>
          </div>
        </div>

        <div class="hr"></div>
      </div>

      <h2>Composição (simulação / negociação)</h2>
      <div class="muted" style="margin-top:-6px;font-size:12px">
        <span id="help_composicao">Regra: Financiamento = Total − Entrada − Subsídio − Por fora.</span>
      </div>

      <div class="row row-3" style="margin-top:10px">
        <div>
          <label>Entrada (R$)</label>
          <input id="entrada" />
        </div>

        <div id="wrap_subsidio">
          <label>Subsídio (R$)</label>
          <input id="subsidio" />
        </div>

        <div id="wrap_porfora">
          <label>Valor por fora (R$)</label>
          <input id="valor_por_fora" placeholder="Ex: 10.000"/>
        </div>
      </div>

      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" id="btnCalcular">Calcular</button>
        <button class="btn secondary" id="btnSalvar">Salvar Lead (Histórico)</button>
        <button class="btn secondary" id="btnPDF">Gerar PDF</button>
      </div>

      <div id="msg2" style="margin-top:12px"></div>
    </div>

    <div class="card">
      <div class="print-area" id="printArea">

        <div style="display:flex;gap:16px;align-items:center">
          <img src="logo.png" style="height:70px;object-fit:contain"/>
          <div>
            <div style="font-weight:700;font-size:16px" id="c_nome">—</div>
            <div style="font-size:12px" id="c_dados">—</div>
            <div style="font-size:12px" id="c_contato">—</div>
          </div>
        </div>

        <div class="hr"></div>

        <div id="resHeader"></div>
        <div class="hr"></div>

        <div id="resBody"></div>

        <div class="hr"></div>

        <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
          <div style="font-size:15px"><b>Custas previstas:</b> <span id="resCustas">—</span></div>
          <div style="font-size:16px"><b>Total geral:</b> <span id="resTotal">—</span></div>
        </div>

        <div class="hr"></div>

        <div style="font-size:12px">
          <b>Corretor:</b> <span id="b_nome">—</span> |
          <b>CRECI:</b> <span id="b_creci">—</span> |
          <b>Contato:</b> <span id="b_tel">—</span>
        </div>

        <!-- MAIS ESPAÇO PARA ASSINATURA (4 linhas úteis) -->
        <div style="margin-top:18px;display:flex;justify-content:space-between;gap:18px">
          <div style="text-align:center;flex:1">
            <div style="height:80px"></div>
            ___________________________________<br/>
            <b id="b_assinatura">Assinatura do Corretor</b>
          </div>
          <div style="text-align:center;flex:1">
            <div style="height:80px"></div>
            ___________________________________<br/>
            <b id="c_assinatura_nome">—</b><br/>
            <span id="c_assinatura_cargo">—</span>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<script src="app.js"></script>
<script>
let CONFIG=null, COMPANY=null, BROKER=null;

function showMsg(el, txt, ok=true){
  el.innerHTML = '<div class="notice '+(ok?'ok':'err')+'">'+txt+'</div>';
}

function lockForPasswordChange(){
  $('changePassCard').style.display = 'block';
  $('appGrid').style.display = 'none';
}
function unlockAfterPasswordChange(){
  $('changePassCard').style.display = 'none';
  $('appGrid').style.display = '';
}

function refreshMenu(){
  const {token,user}=getSession();
  $('whoMini').textContent = token ? (user.name+' ('+user.role+')') : '';
  $('crmLinkTop').style.display = token ? 'inline-flex' : 'none';
  $('adminLinkTop').style.display = (token && user.role==='ADMIN') ? 'inline-flex' : 'none';
  $('btnLogoutTop').style.display = token ? 'inline-flex' : 'none';

  $('loginCard').style.display = token ? 'none' : 'block';
  $('btnLogout').style.display = token ? 'inline-flex' : 'none';
  $('who').textContent = token ? (user.name+' ('+user.role+')') : '';
}

function setDefaults(){
  $('data_simulacao').value = todayISO();
}

function toggleTipoFinUI(){
  const tf = $('tipo_financiamento').value;
  const isProprio = (tf === 'PROPRIO');

  if(isProprio){
    $('wrap_subsidio').style.display = 'none';
    $('wrap_porfora').style.display = 'none';
    $('subsidio').value = '0';
    $('valor_por_fora').value = '0';
    $('help_composicao').textContent = 'Recursos próprios: Saldo = Total − Entrada.';
  } else {
    $('wrap_subsidio').style.display = 'block';
    $('wrap_porfora').style.display = 'block';
    $('help_composicao').textContent = 'Regra: Financiamento = Total − Entrada − Subsídio − Por fora.';
  }

  toggleSimulacaoUI();
}

function toggleCalcadaUI(){
  const city = $('cidade').value;
  const pc = $('possui_calcada').value;
  const show = (city === 'BOA_VISTA' && pc === 'NAO' && $('tipo_simulacao').value === 'CONSTRUCAO');
  $('wrap_calcada_ml').style.display = show ? 'block' : 'none';
  if(!show) $('calcada_metros_lineares').value = '';
}

function toggleTerrenoUI(){
  const op = $('operacao').value;
  const tp = $('terreno_proprio').value;
  const tf = $('tipo_financiamento').value;

  if(tf === 'PROPRIO'){
    $('wrap_valor_terreno').style.display = 'none';
    $('valor_terreno').value = '0';
    return;
  }

  const show = (op === 'TERRENO_E_CONSTRUCAO' && tp !== 'SIM');
  $('wrap_valor_terreno').style.display = show ? 'block' : 'none';
  if(!show) $('valor_terreno').value = '0';
}

function toggleSimulacaoUI(){
  const tipoSim = $('tipo_simulacao').value;
  const tf = $('tipo_financiamento').value;

  if(tipoSim === 'VENDA'){
    $('secVenda').style.display = 'block';
    $('secConstrucao').style.display = 'none';

    // não usa dados de construção
    $('operacao').value = 'CONSTRUCAO_APENAS';
    $('terreno_proprio').value = 'SIM';
    $('valor_terreno').value = '0';
    $('area_m2').value = '';
    $('possui_calcada').value = 'SIM';
    $('calcada_metros_lineares').value = '';

    // primeiro imóvel só faz sentido Boa Vista
    $('wrap_primeiro_imovel').style.display = ($('cidade').value === 'BOA_VISTA') ? 'block' : 'none';

  } else {
    $('secVenda').style.display = 'none';
    $('secConstrucao').style.display = 'block';

    $('wrap_primeiro_imovel').style.display = 'none';
    $('primeiro_imovel').value = 'NAO';

    toggleTerrenoUI();
    toggleCalcadaUI();
  }

  // PROPRIO: não tem subsídio/por fora; (já tratado)
  // Venda PROPRIO: não tem vistoria/taxa/alienação, apenas ITBI (e saldo)
  // Construção PROPRIO: sem vistoria/taxa/alienação/TAO, mas com alvará/habite/averba/cno etc
}

function renderCompanyBroker(){
  if(COMPANY){
    $('c_nome').textContent = COMPANY.nome_fantasia || '—';
    $('c_dados').textContent = (COMPANY.razao_social || '—') + ' | CNPJ ' + (COMPANY.cnpj || '—');
    $('c_contato').textContent =
      (COMPANY.endereco || '') +
      (COMPANY.telefone ? (' | '+COMPANY.telefone) : '') +
      (COMPANY.email ? (' | '+COMPANY.email) : '');
    $('c_assinatura_nome').textContent = COMPANY.assinatura_nome || '—';
    $('c_assinatura_cargo').textContent = COMPANY.assinatura_cargo || '—';
  }
  if(BROKER){
    $('b_nome').textContent = BROKER.nome_completo || BROKER.apelido || '—';
    $('b_creci').textContent = BROKER.creci || '—';
    $('b_tel').textContent = BROKER.telefone || '—';
    $('b_assinatura').textContent = (BROKER.apelido || BROKER.nome_completo || 'Corretor') + (BROKER.creci ? (' | CRECI '+BROKER.creci) : '');
  }
}

function readPayload(){
  let lead_id = $('cliente_telefone').dataset.leadId || '';
  if(!lead_id){
    lead_id = uuid();
    $('cliente_telefone').dataset.leadId = lead_id;
  }

  return {
    lead_id,
    cliente_nome: $('cliente_nome').value,
    cliente_telefone: $('cliente_telefone').value,

    data_simulacao: $('data_simulacao').value,
    validade_dias: $('validade_dias').value,

    tipo_financiamento: $('tipo_financiamento').value,
    tipo_simulacao: $('tipo_simulacao').value,

    cidade: $('cidade').value,
    renda_bruta_familiar: $('renda_bruta_familiar').value,
    primeiro_imovel: $('primeiro_imovel').value,

    // VENDA
    tipo_imovel: $('tipo_imovel').value,
    valor_imovel: $('valor_imovel').value,

    // CONSTRUÇÃO
    operacao: $('operacao').value,
    terreno_proprio: $('terreno_proprio').value,
    valor_terreno: $('valor_terreno').value,

    area_m2: $('area_m2').value,
    padrao: $('padrao').value,
    laje: $('laje').value,

    entrada: $('entrada').value,
    subsidio: $('subsidio').value,
    valor_por_fora: $('valor_por_fora').value,

    possui_calcada: $('possui_calcada').value,
    calcada_metros_lineares: $('calcada_metros_lineares').value
  };
}

function renderReport(payload, calc){
  const isProprio = (payload.tipo_financiamento === 'PROPRIO');
  const isVenda = (payload.tipo_simulacao === 'VENDA');

  const validadeDate = calc.dataVal ? formatDateBR(calc.dataVal) : '—';

  $('resHeader').innerHTML = `
    <div style="font-size:13px">
      <b>Cliente:</b> ${payload.cliente_nome || '—'} | ${payload.cliente_telefone || '—'}<br/>
      <b>Data da simulação:</b> ${formatDateBR(calc.dataSim)} |
      <b>Validade até:</b> ${validadeDate}<br/>
      <b>Cidade:</b> ${payload.cidade} |
      <b>Tipo:</b> ${payload.tipo_simulacao} |
      <b>Operação:</b> ${payload.tipo_financiamento}
      ${isVenda ? ` | <b>Imóvel:</b> ${payload.tipo_imovel}` : ``}
    </div>
  `;

  const boxStyle = "padding:10px;border:1px solid #ddd;border-radius:12px;margin:10px 0;";
  const strongStyle = "font-size:15px;font-weight:700;";

  // =========================
  // VENDA
  // =========================
  if(isVenda){
    const valorImovel = num(payload.valor_imovel);

    const finBox = isProprio
      ? `
        <div style="${boxStyle}">
          <div style="${strongStyle}">Composição (Recursos próprios)</div>
          <div><b>Valor do imóvel:</b> ${formatBRL(valorImovel)}</div>
          <div><b>Entrada:</b> ${formatBRL(calc.entrada)}</div>
          <div style="margin-top:8px"><b>Saldo a negociar:</b> ${formatBRL(calc.saldoNegociar || 0)}</div>
        </div>
      `
      : `
        <div style="${boxStyle}">
          <div style="${strongStyle}">Composição do Financiamento</div>
          <div><b>Valor do imóvel:</b> ${formatBRL(valorImovel)}</div>
          <div><b>Entrada:</b> ${formatBRL(calc.entrada)}</div>
          <div><b>Subsídio:</b> ${formatBRL(calc.subsidio)}</div>
          <div><b>Valor por fora:</b> ${formatBRL(calc.porFora)}</div>
          <div style="margin-top:8px"><b>Valor a financiar (calculado):</b> ${formatBRL(calc.valorAFinanciar)}</div>
          <div class="muted" style="font-size:12px;margin-top:6px">Fórmula: Valor do imóvel − Entrada − Subsídio − Por fora</div>
        </div>
      `;

    const taxaExpl = `${formatPct(calc.taxaFinPerc)} × ${formatBRL(calc.valorFinBase)} = ${formatBRL(calc.taxaFinR)}`;

    let itbiExpl = '—';
    if(calc.itbi === 0){
      if(payload.cidade === 'BOA_VISTA' && calc.itbiIsentoBV){
        itbiExpl = `Isento em Boa Vista (primeiro imóvel) por atender ao limite de ${num(CONFIG.LIMITE_ISENCAO_SM)} salários mínimos (renda informada).`;
      } else {
        itbiExpl = `ITBI zerado / não aplicável conforme regras.`;
      }
    } else {
      itbiExpl = `${formatPct(calc.itbiPercAplicada)} × ${formatBRL(valorImovel)} = ${formatBRL(calc.itbi)}`;
    }

    const custos = `
      <table class="table">
        ${!isProprio ? `
          <tr><td><b>Vistoria Caixa</b></td><td style="text-align:right"><b>${formatBRL(calc.vistoria)}</b></td></tr>

          <tr>
            <td><b>Taxa de financiamento</b><div class="muted" style="font-size:11px">${taxaExpl}</div></td>
            <td style="text-align:right"><b>${formatBRL(calc.taxaFinR)}</b></td>
          </tr>
        ` : ``}

        <tr>
          <td><b>ITBI (imóvel)</b><div class="muted" style="font-size:11px">${itbiExpl}</div></td>
          <td style="text-align:right"><b>${formatBRL(calc.itbi)}</b></td>
        </tr>

        ${!isProprio ? `
          <tr><td><b>Registro de Alienação</b></td><td style="text-align:right"><b>${formatBRL(calc.regAlienacao)}</b></td></tr>
        ` : ``}
      </table>
    `;

    $('resBody').innerHTML = `${finBox}${custos}`;
    $('resCustas').textContent = formatBRL(calc.custasPrevistas);
    $('resTotal').textContent = formatBRL(calc.totalGeral);
    return;
  }

  // =========================
  // CONSTRUÇÃO
  // =========================
  const isCanta = (payload.cidade === "CANTA");
  const isBV = (payload.cidade === "BOA_VISTA");

  const terrenoEntra = (payload.tipo_financiamento !== 'PROPRIO' && payload.terreno_proprio !== 'SIM' && payload.operacao === 'TERRENO_E_CONSTRUCAO');

  const pad = calc.padraoInfo;

  const padBox = `
    <div style="${boxStyle}">
      <div style="${strongStyle}">Padrão selecionado</div>
      <div><b>${pad.label}</b></div>
      <div class="muted" style="font-size:12px;margin-top:4px">${pad.desc}</div>
      <div style="margin-top:6px"><b>Valor do m² aplicado:</b> ${formatBRL(pad.m2)} / m²</div>
    </div>
  `;

  const resumoImovel = `
    <div style="${boxStyle}">
      <div style="${strongStyle}">Resumo do Imóvel</div>
      <div><b>Valor da Obra:</b> ${formatBRL(calc.valorObra)}</div>
      ${terrenoEntra ? `<div><b>Valor do Terreno:</b> ${formatBRL(calc.valorTerrenoCalc)}</div>` : ``}
      <div style="margin-top:6px"><b>Total:</b> ${formatBRL(calc.totalTerrenoConstrucao)}</div>
    </div>
  `;

  const finBox = isProprio
    ? `
      <div style="${boxStyle}">
        <div style="${strongStyle}">Composição (Recursos próprios)</div>
        <div><b>Total (Construção):</b> ${formatBRL(calc.totalTerrenoConstrucao)}</div>
        <div><b>Entrada:</b> ${formatBRL(calc.entrada)}</div>
        <div style="margin-top:8px"><b>Saldo a negociar durante a fase de obra:</b> ${formatBRL(calc.saldoNegociar || 0)}</div>
      </div>
    `
    : `
      <div style="${boxStyle}">
        <div style="${strongStyle}">Composição do Financiamento</div>
        <div><b>Total (Terreno + Construção):</b> ${formatBRL(calc.totalTerrenoConstrucao)}</div>
        <div><b>Entrada:</b> ${formatBRL(calc.entrada)}</div>
        <div><b>Subsídio:</b> ${formatBRL(calc.subsidio)}</div>
        <div><b>Valor por fora:</b> ${formatBRL(calc.porFora)}</div>
        <div style="margin-top:8px"><b>Valor a financiar (calculado):</b> ${formatBRL(calc.valorAFinanciar)}</div>
        <div class="muted" style="font-size:12px;margin-top:6px">Fórmula: Total − Entrada − Subsídio − Por fora</div>
      </div>
    `;

  const projetoLabel = (calc.projetoTipo === 'COM_ESTRUTURAL') ? 'Projeto (com estrutural)' : 'Projeto (sem estrutural)';
  const projetoExpl = `${formatBRL(calc.projetoRateM2)} / m² × ${calc.area.toLocaleString('pt-BR')} m² = ${formatBRL(calc.projetoValor)}`;

  let alvaraExpl = `${formatBRL(calc.alvaraRate)} / m² × ${calc.area.toLocaleString('pt-BR')} m² = ${formatBRL(calc.alvara)}`;
  let habiteExpl = `${formatBRL(calc.habiteRate)} / m² × ${calc.area.toLocaleString('pt-BR')} m² = ${formatBRL(calc.habite)}`;

  if(isCanta){
    alvaraExpl =
      `Autenticação: ${formatBRL(calc.alvaraRate)} × 20 = ${formatBRL(calc.canta_autent)} | ` +
      `Execução: ${formatBRL(calc.alvaraRate)} × ${calc.area.toLocaleString('pt-BR')} m² = ${formatBRL(calc.canta_execucao)} | ` +
      `Legalização: 50% da Execução = ${formatBRL(calc.canta_legalizacao)} | ` +
      `Total: ${formatBRL(calc.alvara)}`;
    habiteExpl = `${formatBRL(calc.habiteRate)} / m² × ${calc.area.toLocaleString('pt-BR')} m² = ${formatBRL(calc.habite)}`;
  }

  const rowAlvara = `
    <tr>
      <td><b>Alvará de Construção</b><div class="muted" style="font-size:11px">${alvaraExpl}</div></td>
      <td style="text-align:right"><b>${formatBRL(calc.alvara)}</b></td>
    </tr>
  `;
  const rowHabite = `
    <tr>
      <td><b>Habite-se</b><div class="muted" style="font-size:11px">${habiteExpl}</div></td>
      <td style="text-align:right"><b>${formatBRL(calc.habite)}</b></td>
    </tr>
  `;

  const taxaExpl = `${formatPct(calc.taxaFinPerc)} × ${formatBRL(calc.valorFinBase)} = ${formatBRL(calc.taxaFinR)}`;

  let itbiExpl = '—';
  if(calc.itbi === 0){
    if(payload.operacao !== 'TERRENO_E_CONSTRUCAO' || payload.terreno_proprio === 'SIM'){
      itbiExpl = 'Não aplicável (terreno próprio ou construção apenas).';
    } else if(payload.cidade === 'BOA_VISTA' && calc.itbiIsentoBV){
      itbiExpl = `Isento em Boa Vista por atender ao limite de ${num(CONFIG.LIMITE_ISENCAO_SM)} salários mínimos (renda informada).`;
    } else {
      itbiExpl = `Não aplicável / valor 0.`;
    }
  } else {
    itbiExpl = `${formatPct(calc.itbiPercAplicada)} × ${formatBRL(calc.valorTerrenoCalc)} = ${formatBRL(calc.itbi)}`;
  }

  const taoExpl = (payload.tipo_financiamento === 'MCMV')
    ? `${formatPct(calc.taoPerc)} × ${formatBRL(calc.valorFinBase)} = ${formatBRL(calc.tao)}`
    : `${formatBRL(calc.taoFixo)} (fixo)`;

  const calcadaML = num(payload.calcada_metros_lineares);
  const calcadaExpl = (isBV && payload.possui_calcada === "NAO")
    ? `${formatBRL(calc.calcadaPrecoML)} / m × ${calcadaML.toLocaleString('pt-BR')} m = ${formatBRL(calc.calcada)}`
    : 'Não aplicável.';

  const showLaje = calc.temLaje && calc.laje > 0;
  const showCno = (calc.area > 70 && calc.cno > 0);

  // ORDEM CORRETA:
  // Construção base -> (Laje se tiver) -> Projeto -> CREA
  // Alvará: BV sempre após CREA; Cantá: PROPRIO após CREA; Cantá BANCO após Alienação
  // Vistoria -> Taxa -> ITBI -> Alienação -> (Alvará Cantá BANCO) -> TAO
  // Calçada -> Habite-se (sempre após Calçada) -> CNO (se >70) -> Averbação

  const custos = `
    <table class="table">
      <tr><td><b>Construção base</b></td><td style="text-align:right"><b>${formatBRL(calc.custoBase)}</b></td></tr>

      ${showLaje ? `
        <tr>
          <td><b>Laje</b><div class="muted" style="font-size:11px">${formatBRL(calc.lajeAd)} / m² × ${calc.area.toLocaleString('pt-BR')} m²</div></td>
          <td style="text-align:right"><b>${formatBRL(calc.laje)}</b></td>
        </tr>
      ` : ``}

      <tr>
        <td><b>${projetoLabel}</b><div class="muted" style="font-size:11px">${projetoExpl}</div></td>
        <td style="text-align:right"><b>${formatBRL(calc.projetoValor)}</b></td>
      </tr>

      <tr>
        <td><b>ART's do CREA</b><div class="muted" style="font-size:11px">Faixa por área: ${calc.area.toLocaleString('pt-BR')} m²</div></td>
        <td style="text-align:right"><b>${formatBRL(calc.crea || 0)}</b></td>
      </tr>

      ${/* Alvará após CREA: BV sempre; Cantá quando PROPRIO */''}
      ${(isBV || (isCanta && isProprio)) ? rowAlvara : ``}

      ${!isProprio ? `
        <tr><td><b>Vistoria Caixa</b></td><td style="text-align:right"><b>${formatBRL(calc.vistoria)}</b></td></tr>

        <tr>
          <td><b>Taxa de financiamento</b><div class="muted" style="font-size:11px">${taxaExpl}</div></td>
          <td style="text-align:right"><b>${formatBRL(calc.taxaFinR)}</b></td>
        </tr>

        <tr>
          <td><b>ITBI (terreno)</b><div class="muted" style="font-size:11px">${itbiExpl}</div></td>
          <td style="text-align:right"><b>${formatBRL(calc.itbi)}</b></td>
        </tr>

        <tr><td><b>Registro de Alienação</b></td><td style="text-align:right"><b>${formatBRL(calc.regAlienacao)}</b></td></tr>

        ${/* Cantá com banco: alvará após alienação */''}
        ${(isCanta && !isProprio) ? rowAlvara : ``}

        <tr>
          <td><b>TAO</b><div class="muted" style="font-size:11px">${taoExpl}</div></td>
          <td style="text-align:right"><b>${formatBRL(calc.tao)}</b></td>
        </tr>
      ` : ``}

      <tr>
        <td><b>Calçada</b><div class="muted" style="font-size:11px">${calcadaExpl}</div></td>
        <td style="text-align:right"><b>${formatBRL(calc.calcada)}</b></td>
      </tr>

      ${/* HABITE-SE SEMPRE APÓS CALÇADA (BV e CANTÁ) */''}
      ${rowHabite}

      ${showCno ? `<tr><td><b>CNO (Receita Federal)</b></td><td style="text-align:right"><b>${formatBRL(calc.cno)}</b></td></tr>` : ``}

      <tr>
        <td><b>Averbação da Obra</b><div class="muted" style="font-size:11px">Faixa pelo valor da obra: ${formatBRL(calc.valorObra)}</div></td>
        <td style="text-align:right"><b>${formatBRL(calc.averbacao)}</b></td>
      </tr>
    </table>
  `;

  $('resBody').innerHTML = `${padBox}${resumoImovel}${finBox}${custos}`;
  $('resCustas').textContent = formatBRL(calc.custasPrevistas);
  $('resTotal').textContent = formatBRL(calc.totalGeral);
}

async function loadAfterLogin(token){
  const cfg = await getConfig(token);
  if(!cfg.ok) throw new Error(cfg.error || 'Erro ao carregar Config');
  CONFIG = cfg.config;

  const ft = await getFeeTables(token);
  if(ft.ok) FEE_TABLES = ft.tables;

  const c = await getCompany(token);
  if(c.ok) COMPANY = c.company;

  const b = await getBroker(token);
  if(b.ok) BROKER = b.broker;

  renderCompanyBroker();
}

$('btnLogin').onclick = async ()=>{
  try{
    const r = await apiPost({action:'login', email:$('email').value, password:$('password').value});
    if(!r.ok) return showMsg($('msg'), r.error || 'Erro no login', false);

    setSession(r.token, r.user);
    refreshMenu();

    if (r.user && r.user.mustChangePassword) {
      lockForPasswordChange();
      showMsg($('msg'), 'Você precisa trocar sua senha para continuar.', false);
      return;
    }

    await loadAfterLogin(r.token);
    showMsg($('msg'), 'Login realizado e configurações carregadas.', true);

    const toLoad = getLeadToLoad();
    if(toLoad){
      fillFormFromLead(toLoad);
      clearLeadToLoad();
      showMsg($('msg2'), 'Lead carregado do CRM. Você pode recalcular e salvar um novo histórico.', true);
    }
  } catch(e){
    showMsg($('msg'), String(e), false);
  }
};

function doLogout(){
  clearSession();
  CONFIG=null; COMPANY=null; BROKER=null; FEE_TABLES=null;
  unlockAfterPasswordChange();
  refreshMenu();
  showMsg($('msg'), 'Sessão encerrada.', true);
}
$('btnLogout').onclick = doLogout;
$('btnLogoutTop').onclick = doLogout;

$('btnChangePass').onclick = async ()=>{
  try{
    const {token} = getSession();
    if(!token) return showMsg($('msgPass'), 'Sem sessão. Faça login novamente.', false);

    const newPassword = $('newPass').value;
    const confirmPassword = $('newPass2').value;

    const r = await apiPost({ action:'changePassword', token, newPassword, confirmPassword });
    if(!r.ok) return showMsg($('msgPass'), r.error || 'Erro ao trocar senha.', false);

    showMsg($('msgPass'), 'Senha alterada com sucesso. Faça login novamente.', true);

    clearSession();
    unlockAfterPasswordChange();
    refreshMenu();
    $('newPass').value = '';
    $('newPass2').value = '';
  } catch(e){
    showMsg($('msgPass'), String(e), false);
  }
};
$('btnChangePassLogout').onclick = doLogout;

$('btnCalcular').onclick = ()=>{
  const {token} = getSession();
  if(!token) return showMsg($('msg2'), 'Faça login primeiro.', false);
  if(!CONFIG) return showMsg($('msg2'), 'Config não carregada. Saia e faça login novamente.', false);

  const payload = readPayload();
  const calc = calcTotal(payload, CONFIG);
  renderReport(payload, calc);
  showMsg($('msg2'), 'Cálculo atualizado.', true);
};

$('btnSalvar').onclick = async ()=>{
  const {token} = getSession();
  if(!token) return showMsg($('msg2'), 'Faça login primeiro.', false);
  if(!CONFIG) return showMsg($('msg2'), 'Config não carregada. Saia e faça login novamente.', false);

  const payload = readPayload();
  const calc = calcTotal(payload, CONFIG);

  payload.total_estimado = calc.totalGeral;
  payload.custas_previstas = calc.custasPrevistas;
  payload.valor_a_financiar = calc.valorAFinanciar;
  payload.last_calc_json = JSON.stringify(calc);

  payload.status = payload.status || 'NOVO';
  payload.next_action_at = payload.next_action_at || '';
  payload.notes = payload.notes || '';

  const r = await saveLead(token, payload);
  showMsg($('msg2'), r.ok ? 'Lead salvo como NOVO HISTÓRICO (nova linha).' : (r.error || 'Erro ao salvar'), !!r.ok);
};

$('btnPDF').onclick = ()=> window.print();

// binds
$('tipo_financiamento').onchange = toggleTipoFinUI;
$('tipo_simulacao').onchange = toggleSimulacaoUI;
$('cidade').onchange = ()=>{ toggleCalcadaUI(); toggleSimulacaoUI(); };
$('operacao').onchange = toggleTerrenoUI;
$('terreno_proprio').onchange = toggleTerrenoUI;
$('possui_calcada').onchange = toggleCalcadaUI;

setDefaults();
refreshMenu();
toggleTipoFinUI();
toggleSimulacaoUI();
toggleCalcadaUI();

async function boot(){
  const {token,user} = getSession();
  if(token){
    try{
      refreshMenu();
      if(user && user.mustChangePassword){
        lockForPasswordChange();
        return;
      }
      await loadAfterLogin(token);

      const toLoad = getLeadToLoad();
      if(toLoad){
        fillFormFromLead(toLoad);
        clearLeadToLoad();
        showMsg($('msg2'), 'Lead carregado do CRM. Você pode recalcular e salvar novo histórico.', true);
      }
    }catch(_){
      doLogout();
    }
  }
}
boot();

// ===== carregar do CRM para o formulário =====
function fillFormFromLead(lead){
  if(!lead) return;
  const p = lead.payload || lead;

  const setVal = (id, val) => {
    const el = document.getElementById(id);
    if(!el) return;
    el.value = (val === undefined || val === null) ? "" : String(val);
  };
  const setSel = (id, val) => {
    const el = document.getElementById(id);
    if(!el) return;
    if(val === undefined || val === null || val === "") return;
    el.value = String(val);
  };

  const leadId = p.lead_id || p.leadId || p.id || "";
  if(leadId){
    const telEl = document.getElementById("cliente_telefone");
    if(telEl) telEl.dataset.leadId = leadId;
  }

  setVal("cliente_nome", p.cliente_nome);
  setVal("cliente_telefone", p.cliente_telefone);
  setVal("data_simulacao", p.data_simulacao || todayISO());
  setVal("validade_dias", p.validade_dias);

  setSel("tipo_financiamento", p.tipo_financiamento);
  setSel("tipo_simulacao", p.tipo_simulacao || "CONSTRUCAO");

  setSel("cidade", p.cidade);
  setVal("renda_bruta_familiar", p.renda_bruta_familiar);
  setSel("primeiro_imovel", p.primeiro_imovel || "NAO");

  setSel("tipo_imovel", p.tipo_imovel || "NOVO");
  setVal("valor_imovel", p.valor_imovel);

  setSel("operacao", p.operacao);
  setSel("terreno_proprio", p.terreno_proprio);
  setVal("valor_terreno", p.valor_terreno);

  setVal("area_m2", p.area_m2);
  setSel("padrao", p.padrao);
  setSel("laje", p.laje);

  setVal("entrada", p.entrada);
  setVal("subsidio", p.subsidio);
  setVal("valor_por_fora", p.valor_por_fora);

  setSel("possui_calcada", p.possui_calcada || "SIM");
  setVal("calcada_metros_lineares", p.calcada_metros_lineares);

  toggleTipoFinUI();
  toggleSimulacaoUI();
  toggleTerrenoUI();
  toggleCalcadaUI();
}
</script>
</body>
</html>
