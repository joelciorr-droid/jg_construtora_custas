<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>JG | Simulador de Construção</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
<div class="container">

  <!-- Top menu -->
  <div class="card no-print" style="display:flex;gap:10px;align-items:center;justify-content:space-between">
    <div style="display:flex;gap:10px;align-items:center">
      <b>JG | Simulador</b>
      <span class="badge" id="whoMini"></span>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <a class="btn secondary" href="index.html">Simulador</a>
      <a class="btn secondary" id="crmLinkTop" href="crm.html" style="display:none">CRM</a>
      <a class="btn secondary" id="adminLinkTop" href="admin.html" style="display:none">Admin/Config</a>
      <button class="btn secondary" id="btnLogoutTop" style="display:none">Sair</button>
    </div>
  </div>

  <!-- LOGIN -->
  <div class="card no-print" id="loginCard">
    <h1>JG | Proposta de Construção</h1>
    <div class="muted">Acesso exclusivo para corretores autorizados</div>
    <div class="hr"></div>

    <div class="row row-2">
      <div>
        <label>E-mail</label>
        <input id="email" type="email" autocomplete="username"/>
      </div>
      <div>
        <label>Senha</label>
        <input id="password" type="password" autocomplete="current-password"/>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <button class="btn" id="btnLogin">Entrar</button>
      <button class="btn secondary" id="btnLogout" style="display:none">Sair</button>
      <span class="badge" id="who"></span>
    </div>

    <div id="msg" style="margin-top:12px"></div>
  </div>
  
  <!-- TROCA DE SENHA OBRIGATÓRIA -->
  <div class="card no-print" id="changePassCard" style="display:none">
    <h2>Troca de senha obrigatória</h2>
    <div class="muted">Defina sua nova senha para continuar.</div>
    <div class="hr"></div>

    <div class="row row-2">
      <div>
        <label>Nova senha</label>
        <input id="newPass" type="password" autocomplete="new-password"/>
      </div>
      <div>
        <label>Confirmar nova senha</label>
        <input id="newPass2" type="password" autocomplete="new-password"/>
      </div>
    </div>

    <div class="actions" style="margin-top:12px">
      <button class="btn" id="btnChangePass">Salvar nova senha</button>
      <button class="btn secondary" id="btnChangePassLogout">Sair</button>
    </div>

    <div id="msgPass" style="margin-top:12px"></div>
  </div>
  
  <div class="grid grid-2" style="margin-top:16px">

    <!-- FORM -->
    <div class="card no-print">
      <h2>Dados do Cliente</h2>
      <div class="hr"></div>

      <div class="row row-2">
        <div>
          <label>Nome do cliente</label>
          <input id="cliente_nome" />
        </div>
        <div>
          <label>Telefone</label>
          <input id="cliente_telefone" />
        </div>
      </div>

      <div class="row row-3" style="margin-top:10px">
        <div>
          <label>Data da simulação</label>
          <input id="data_simulacao" type="date"/>
        </div>
        <div>
          <label>Validade (dias)</label>
          <input id="validade_dias" placeholder="Ex: 7"/>
          <div class="muted" style="font-size:12px;margin-top:6px">Se vazio, usa o padrão da configuração.</div>
        </div>
        <div>
          <label>Tipo de financiamento</label>
          <select id="tipo_financiamento">
            <option value="MCMV">Minha Casa Minha Vida</option>
            <option value="OUTROS">SBPE / Outros</option>
          </select>
        </div>
      </div>

      <div class="row row-3" style="margin-top:10px">
        <div>
          <label>Cidade</label>
          <select id="cidade">
            <option value="BOA_VISTA">Boa Vista</option>
            <option value="CANTA">Cantá</option>
            <option value="OUTRO">Outro</option>
          </select>
        </div>
        <div>
          <label>Operação</label>
          <select id="operacao">
            <option value="TERRENO_E_CONSTRUCAO" selected>Terreno + Construção</option>
            <option value="CONSTRUCAO_APENAS">Construção apenas</option>
          </select>
        </div>
        <div>
          <label>Terreno próprio?</label>
          <select id="terreno_proprio">
            <option value="SIM">Sim</option>
            <option value="NAO" selected>Não</option>
          </select>
        </div>
      </div>

      <div class="row row-2" style="margin-top:10px">
        <div id="wrap_valor_terreno">
          <label>Valor do terreno (R$)</label>
          <input id="valor_terreno" />
        </div>
        <div>
          <label>Renda bruta familiar (R$) (para ITBI Boa Vista)</label>
          <input id="renda_bruta_familiar" />
        </div>
      </div>

      <div class="hr"></div>

      <h2>Dados da Obra</h2>

      <div class="row row-3">
        <div>
          <label>Área construída (m²)</label>
          <input id="area_m2" />
        </div>
        <div>
          <label>Padrão</label>
          <select id="padrao">
            <option value="C">Tipo C</option>
            <option value="B">Tipo B</option>
            <option value="A" selected>Tipo A</option>
          </select>
        </div>
        <div>
          <label>Laje</label>
          <select id="laje">
            <option value="NAO" selected>Não</option>
            <option value="SIM">Sim</option>
          </select>
          <div class="muted" style="font-size:12px;margin-top:6px">Sem laje: projeto sem estrutural. Com laje: projeto com estrutural.</div>
        </div>
      </div>

      <div class="row row-1" style="margin-top:10px">
        <div>
          <label>Valor financiado (opcional)</label>
          <input id="valor_financiado" placeholder="Se preencher Entrada/Subsídio/Por fora, pode deixar em branco"/>
        </div>
      </div>

      <div class="hr"></div>

      <h2>Simulador Caixa</h2>
      <div class="muted" style="margin-top:-6px;font-size:12px">
        Regra: Financiamento = Total (Terreno + Construção) − Entrada − Subsídio − Por fora.
      </div>

      <div class="row row-3" style="margin-top:10px">
        <div>
          <label>Entrada (R$)</label>
          <input id="entrada" />
        </div>
        <div>
          <label>Subsídio (R$)</label>
          <input id="subsidio" />
        </div>
        <div>
          <label>Valor por fora (R$)</label>
          <input id="valor_por_fora" placeholder="Ex: 10.000"/>
        </div>
      </div>

      <div class="hr"></div>

      <h2>Calçada (Boa Vista)</h2>

      <div class="row row-2" style="margin-top:10px">
        <div>
          <label>Possui calçada?</label>
          <select id="possui_calcada">
            <option value="SIM" selected>Sim</option>
            <option value="NAO">Não</option>
          </select>
        </div>
        <div id="wrap_calcada_ml">
          <label>Metragem linear total (m)</label>
          <input id="calcada_metros_lineares" placeholder="Ex: 10 (frente) ou 35 (esquina total)"/>
        </div>
      </div>

      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" id="btnCalcular">Calcular</button>
        <button class="btn secondary" id="btnSalvar">Salvar Lead (Histórico)</button>
        <button class="btn secondary" id="btnPDF">Gerar PDF</button>
      </div>

      <div id="msg2" style="margin-top:12px"></div>
    </div>

    <!-- RESUMO / PDF -->
    <div class="card">
      <div class="print-area" id="printArea">

        <div style="display:flex;gap:16px;align-items:center">
          <img src="logo.png" style="height:70px;object-fit:contain"/>
          <div>
            <div style="font-weight:700;font-size:16px" id="c_nome">—</div>
            <div style="font-size:12px" id="c_dados">—</div>
            <div style="font-size:12px" id="c_contato">—</div>
          </div>
        </div>

        <div class="hr"></div>

        <div id="resHeader"></div>
        <div class="hr"></div>

        <div id="resBody"></div>

        <div class="hr"></div>

        <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
          <div style="font-size:15px"><b>Custas previstas:</b> <span id="resCustas">—</span></div>
          <div style="font-size:16px"><b>Total geral:</b> <span id="resTotal">—</span></div>
        </div>

        <div class="hr"></div>

        <div style="font-size:12px">
          <b>Corretor:</b> <span id="b_nome">—</span> |
          <b>CRECI:</b> <span id="b_creci">—</span> |
          <b>Contato:</b> <span id="b_tel">—</span>
        </div>

        <div style="margin-top:14px;display:flex;justify-content:space-between;gap:12px">
          <div style="text-align:center;flex:1">
            ___________________________________<br/>
            <b id="b_assinatura">Assinatura do Corretor</b>
          </div>
          <div style="text-align:center;flex:1">
            ___________________________________<br/>
            <b id="c_assinatura_nome">—</b><br/>
            <span id="c_assinatura_cargo">—</span>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<script src="app.js"></script>
<script>
let CONFIG=null, COMPANY=null, BROKER=null;

function lockForPasswordChange(){
  $('changePassCard').style.display = 'block';
  // esconde área do sistema
  document.querySelectorAll('.grid, .grid-2').forEach(el=> el.style.display='none');
}

function unlockAfterPasswordChange(){
  $('changePassCard').style.display = 'none';
  document.querySelectorAll('.grid, .grid-2').forEach(el=> el.style.display='');
}

function showMsg(el, txt, ok=true){
  el.innerHTML = '<div class="notice '+(ok?'ok':'err')+'">'+txt+'</div>';
}

function refreshMenu(){
  const {token,user}=getSession();
  $('whoMini').textContent = token ? (user.name+' ('+user.role+')') : '';
  $('crmLinkTop').style.display = token ? 'inline-flex' : 'none';
  $('adminLinkTop').style.display = (token && user.role==='ADMIN') ? 'inline-flex' : 'none';
  $('btnLogoutTop').style.display = token ? 'inline-flex' : 'none';

  $('loginCard').style.display = token ? 'none' : 'block';
  $('btnLogout').style.display = token ? 'inline-flex' : 'none';
  $('who').textContent = token ? (user.name+' ('+user.role+')') : '';
}

function toggleTerrenoUI(){
  const op = $('operacao').value;
  const tp = $('terreno_proprio').value;
  const show = (op === 'TERRENO_E_CONSTRUCAO' && tp !== 'SIM');
  $('wrap_valor_terreno').style.display = show ? 'block' : 'none';
  if(!show) $('valor_terreno').value = '0';
}

function toggleCalcadaUI(){
  const city = $('cidade').value;
  const pc = $('possui_calcada').value;
  const show = (city === 'BOA_VISTA' && pc === 'NAO');
  $('wrap_calcada_ml').style.display = show ? 'block' : 'none';
  if(!show) $('calcada_metros_lineares').value = '';
}

function setDefaults(){
  $('data_simulacao').value = todayISO();
}

function renderCompanyBroker(){
  if(COMPANY){
    $('c_nome').textContent = COMPANY.nome_fantasia || '—';
    $('c_dados').textContent = (COMPANY.razao_social || '—') + ' | CNPJ ' + (COMPANY.cnpj || '—');
    $('c_contato').textContent =
      (COMPANY.endereco || '') +
      (COMPANY.telefone ? (' | '+COMPANY.telefone) : '') +
      (COMPANY.email ? (' | '+COMPANY.email) : '');
    $('c_assinatura_nome').textContent = COMPANY.assinatura_nome || '—';
    $('c_assinatura_cargo').textContent = COMPANY.assinatura_cargo || '—';
  }
  if(BROKER){
    $('b_nome').textContent = BROKER.nome_completo || BROKER.apelido || '—';
    $('b_creci').textContent = BROKER.creci || '—';
    $('b_tel').textContent = BROKER.telefone || '—';
    $('b_assinatura').textContent = (BROKER.apelido || BROKER.nome_completo || 'Corretor') + (BROKER.creci ? (' | CRECI '+BROKER.creci) : '');
  }
}

function readPayload(){
  // lead_id fixo para manter histórico: cria uma vez e mantém
  let lead_id = $('cliente_telefone').dataset.leadId || '';
  if(!lead_id){
    lead_id = uuid();
    $('cliente_telefone').dataset.leadId = lead_id;
  }

  return {
    lead_id,

    cliente_nome: $('cliente_nome').value,
    cliente_telefone: $('cliente_telefone').value,

    data_simulacao: $('data_simulacao').value,
    validade_dias: $('validade_dias').value,

    tipo_financiamento: $('tipo_financiamento').value,
    cidade: $('cidade').value,
    operacao: $('operacao').value,
    terreno_proprio: $('terreno_proprio').value,
    valor_terreno: $('valor_terreno').value,
    renda_bruta_familiar: $('renda_bruta_familiar').value,

    area_m2: $('area_m2').value,
    padrao: $('padrao').value,
    laje: $('laje').value,
    valor_financiado: $('valor_financiado').value,

    entrada: $('entrada').value,
    subsidio: $('subsidio').value,
    valor_por_fora: $('valor_por_fora').value,

    possui_calcada: $('possui_calcada').value,
    calcada_metros_lineares: $('calcada_metros_lineares').value
  };
}

function renderReport(payload, calc){
  const validadeDate = calc.dataVal ? formatDateBR(calc.dataVal) : '—';

  $('resHeader').innerHTML = `
    <div style="font-size:13px">
      <b>Cliente:</b> ${payload.cliente_nome || '—'} | ${payload.cliente_telefone || '—'}<br/>
      <b>Data da simulação:</b> ${formatDateBR(calc.dataSim)} |
      <b>Validade até:</b> ${validadeDate}<br/>
      <b>Cidade:</b> ${payload.cidade} |
      <b>Financiamento:</b> ${payload.tipo_financiamento} |
      <b>Área:</b> ${payload.area_m2 || '—'} m² |
      <b>Padrão:</b> ${payload.padrao} |
      <b>Operação:</b> ${payload.operacao} |
      <b>Terreno próprio:</b> ${payload.terreno_proprio}
    </div>
  `;

  const boxStyle = "padding:10px;border:1px solid #ddd;border-radius:12px;margin:10px 0;";
  const strongStyle = "font-size:15px;font-weight:700;";

  const terrenoEntra = (payload.terreno_proprio !== 'SIM' && payload.operacao === 'TERRENO_E_CONSTRUCAO');

  const pad = calc.padraoInfo;
  const padBox = `
    <div style="${boxStyle}">
      <div style="${strongStyle}">Padrão selecionado</div>
      <div><b>${pad.label}</b></div>
      <div class="muted" style="font-size:12px;margin-top:4px">${pad.desc}</div>
      <div style="margin-top:6px"><b>Valor do m² aplicado:</b> ${formatBRL(pad.m2)} / m²</div>
    </div>
  `;

  const resumoImovel = `
    <div style="${boxStyle}">
      <div style="${strongStyle}">Resumo do Imóvel</div>
      <div><b>Valor da Obra:</b> ${formatBRL(calc.valorObra)}</div>
      ${terrenoEntra ? `<div><b>Valor do Terreno:</b> ${formatBRL(calc.valorTerrenoCalc)}</div>` : ``}
      <div style="margin-top:6px"><b>Total (Terreno + Construção):</b> ${formatBRL(calc.totalTerrenoConstrucao)}</div>
    </div>
  `;

  const finBox = `
    <div style="${boxStyle}">
      <div style="${strongStyle}">Composição do Financiamento</div>
      <div><b>Total (Terreno + Construção):</b> ${formatBRL(calc.totalTerrenoConstrucao)}</div>
      <div><b>Entrada:</b> ${formatBRL(calc.entrada)}</div>
      <div><b>Subsídio:</b> ${formatBRL(calc.subsidio)}</div>
      <div><b>Valor por fora:</b> ${formatBRL(calc.porFora)}</div>
      <div style="margin-top:8px"><b>Valor a financiar (calculado):</b> ${formatBRL(calc.valorAFinanciar)}</div>
      <div class="muted" style="font-size:12px;margin-top:6px">
        Fórmula: Total − Entrada − Subsídio − Por fora
      </div>
    </div>
  `;

  // Projetos (automático por laje)
  const projetoLabel = (calc.projetoTipo === 'COM_ESTRUTURAL') ? 'Projeto (com estrutural)' : 'Projeto (sem estrutural)';
  const projetoExpl = `${formatBRL(calc.projetoRateM2)} / m² × ${calc.area.toLocaleString('pt-BR')} m² = ${formatBRL(calc.projetoValor)}`;

  // Taxa financiamento
  const taxaExpl = `${formatPct(calc.taxaFinPerc)} × ${formatBRL(calc.valorFinBase)} = ${formatBRL(calc.taxaFinR)}`;

  // ITBI
  let itbiExpl = '—';
  if(calc.itbi === 0){
    if(payload.operacao !== 'TERRENO_E_CONSTRUCAO' || payload.terreno_proprio === 'SIM'){
      itbiExpl = 'Não aplicável (terreno próprio ou construção apenas).';
    } else if(payload.cidade === 'BOA_VISTA' && calc.itbiIsentoBV){
      itbiExpl = `Isento em Boa Vista por atender ao limite de ${num(CONFIG.LIMITE_ISENCAO_SM)} salários mínimos (renda informada).`;
    } else {
      itbiExpl = `Não aplicável / valor 0.`;
    }
  } else {
    itbiExpl = `${formatPct(calc.itbiPercAplicada)} × ${formatBRL(calc.valorTerrenoCalc)} = ${formatBRL(calc.itbi)}`;
  }

  // TAO
  const taoExpl = (payload.tipo_financiamento === 'MCMV')
    ? `${formatPct(calc.taoPerc)} × ${formatBRL(calc.valorFinBase)} = ${formatBRL(calc.tao)}`
    : `${formatBRL(calc.taoFixo)} (fixo)`;

  // Calçada
  const calcadaML = num(payload.calcada_metros_lineares);
  const calcadaExpl = (payload.cidade === 'BOA_VISTA' && payload.possui_calcada === 'NAO')
    ? `${formatBRL(calc.calcadaPrecoML)} / m × ${calcadaML.toLocaleString('pt-BR')} m = ${formatBRL(calc.calcada)}`
    : 'Não aplicável.';

  // Alvará / Habite-se (tarifa m²)
  const alvaraExpl = `${formatBRL(calc.alvaraRate)} / m² × ${calc.area.toLocaleString('pt-BR')} m² = ${formatBRL(calc.alvara)}`;
  const habiteExpl = `${formatBRL(calc.habiteRate)} / m² × ${calc.area.toLocaleString('pt-BR')} m² = ${formatBRL(calc.habite)}`;

  const showLaje = calc.temLaje && calc.laje > 0;
  const showCno = (calc.area > 70 && calc.cno > 0);

  const custos = `
    <table class="table">
      <tr><td><b>Construção base</b></td><td style="text-align:right"><b>${formatBRL(calc.custoBase)}</b></td></tr>

      ${showLaje ? `<tr><td><b>Laje</b> <div class="muted" style="font-size:11px">${formatBRL(calc.lajeAd)} / m² × ${calc.area.toLocaleString('pt-BR')} m²</div></td><td style="text-align:right"><b>${formatBRL(calc.laje)}</b></td></tr>` : ``}

      <tr>
        <td><b>${projetoLabel}</b><div class="muted" style="font-size:11px">${projetoExpl}</div></td>
        <td style="text-align:right"><b>${formatBRL(calc.projetoValor)}</b></td>
      </tr>

      <tr><td><b>ART's do CREA</b></td><td style="text-align:right"><b>${formatBRL(calc.crea)}</b></td></tr>

      <tr>
        <td><b>Alvará de Construção</b><div class="muted" style="font-size:11px">${alvaraExpl}</div></td>
        <td style="text-align:right"><b>${formatBRL(calc.alvara)}</b></td>
      </tr>

      <tr><td><b>Vistoria Caixa</b></td><td style="text-align:right"><b>${formatBRL(calc.vistoria)}</b></td></tr>

      <tr>
        <td><b>Taxa de financiamento</b><div class="muted" style="font-size:11px">${taxaExpl}</div></td>
        <td style="text-align:right"><b>${formatBRL(calc.taxaFinR)}</b></td>
      </tr>

      <tr>
        <td><b>ITBI (terreno)</b><div class="muted" style="font-size:11px">${itbiExpl}</div></td>
        <td style="text-align:right"><b>${formatBRL(calc.itbi)}</b></td>
      </tr>

      <tr><td><b>Registro de Alienação</b></td><td style="text-align:right"><b>${formatBRL(calc.regAlienacao)}</b></td></tr>

      <tr>
        <td><b>TAO</b><div class="muted" style="font-size:11px">${taoExpl}</div></td>
        <td style="text-align:right"><b>${formatBRL(calc.tao)}</b></td>
      </tr>

      <tr>
        <td><b>Calçada</b><div class="muted" style="font-size:11px">${calcadaExpl}</div></td>
        <td style="text-align:right"><b>${formatBRL(calc.calcada)}</b></td>
      </tr>

      <tr>
        <td><b>Habite-se</b><div class="muted" style="font-size:11px">${habiteExpl}</div></td>
        <td style="text-align:right"><b>${formatBRL(calc.habite)}</b></td>
      </tr>

      ${showCno ? `<tr><td><b>CNO (Receita Federal)</b></td><td style="text-align:right"><b>${formatBRL(calc.cno)}</b></td></tr>` : ``}

      <tr><td><b>Averbação da Obra</b> <div class="muted" style="font-size:11px">Faixa pelo valor da obra: ${formatBRL(calc.valorObra)}</div></td>
          <td style="text-align:right"><b>${formatBRL(calc.averbacao)}</b></td></tr>
    </table>
  `;

  $('resBody').innerHTML = `
    ${padBox}
    ${resumoImovel}
    ${finBox}
    ${custos}
  `;

  $('resCustas').textContent = formatBRL(calc.custasPrevistas);
  $('resTotal').textContent = formatBRL(calc.totalGeral);
}

async function loadAfterLogin(token){
  const cfg = await getConfig(token);
  if(!cfg.ok) throw new Error(cfg.error || 'Erro ao carregar Config');
  CONFIG = cfg.config;

  const ft = await getFeeTables(token);
  if(ft.ok) FEE_TABLES = ft.tables;

  const c = await getCompany(token);
  if(c.ok) COMPANY = c.company;

  const b = await getBroker(token);
  if(b.ok) BROKER = b.broker;

  renderCompanyBroker();
}

function fillFormFromLead(lead){
  // lead pode vir do CRM
  if(!lead) return;

  $('cliente_nome').value = lead.cliente_nome || '';
  $('cliente_telefone').value = lead.cliente_telefone || '';
  if(lead.lead_id) $('cliente_telefone').dataset.leadId = lead.lead_id;

  $('data_simulacao').value = lead.data_simulacao || todayISO();
  $('validade_dias').value = lead.validade_dias || '';

  $('tipo_financiamento').value = lead.tipo_financiamento || 'MCMV';
  $('cidade').value = lead.cidade || 'BOA_VISTA';
  $('operacao').value = lead.operacao || 'TERRENO_E_CONSTRUCAO';
  $('terreno_proprio').value = lead.terreno_proprio || 'NAO';
  $('valor_terreno').value = lead.valor_terreno || '0';
  $('renda_bruta_familiar').value = lead.renda_bruta_familiar || '';

  $('area_m2').value = lead.area_m2 || '';
  $('padrao').value = lead.padrao || 'A';
  $('laje').value = lead.laje || 'NAO';
  $('valor_financiado').value = lead.valor_financiado || '';

  $('entrada').value = lead.entrada || '';
  $('subsidio').value = lead.subsidio || '';
  $('valor_por_fora').value = lead.valor_por_fora || '';

  $('possui_calcada').value = lead.possui_calcada || 'SIM';
  $('calcada_metros_lineares').value = lead.calcada_metros_lineares || '';

  toggleTerrenoUI();
  toggleCalcadaUI();
}

$('btnLogin').onclick = async ()=>{
  try{
    const r = await apiPost({action:'login', email:$('email').value, password:$('password').value});
    if(!r.ok) return showMsg($('msg'), r.error || 'Erro no login', false);

    setSession(r.token, r.user);
    refreshMenu();
    
    // Se precisa trocar senha, bloqueia e não carrega o resto
    if (r.user && r.user.mustChangePassword) {
      lockForPasswordChange();
      showMsg($('msg'), 'Você precisa trocar sua senha para continuar.', false);
      return;
    }
    
    await loadAfterLogin(r.token);
    
    showMsg($('msg'), 'Login realizado e configurações carregadas.', true);

    // Se veio do CRM para editar/continuar
    const toLoad = getLeadToLoad();
    if(toLoad){
      fillFormFromLead(toLoad);
      clearLeadToLoad();
      showMsg($('msg2'), 'Lead carregado do CRM. Você pode recalcular e salvar um novo histórico.', true);
    }
  } catch(e){
    showMsg($('msg'), String(e), false);
  }
};

function doLogout(){
  clearSession();
  CONFIG=null; COMPANY=null; BROKER=null; FEE_TABLES=null;
  refreshMenu();
  showMsg($('msg'), 'Sessão encerrada.', true);
}
$('btnLogout').onclick = doLogout;
$('btnLogoutTop').onclick = doLogout;

$('btnCalcular').onclick = ()=>{
  const {token} = getSession();
  if(!token) return showMsg($('msg2'), 'Faça login primeiro.', false);
  if(!CONFIG) return showMsg($('msg2'), 'Config não carregada. Saia e faça login novamente.', false);

  const payload = readPayload();
  const calc = calcTotal(payload, CONFIG);
  renderReport(payload, calc);
  showMsg($('msg2'), 'Cálculo atualizado.', true);
};

$('btnSalvar').onclick = async ()=>{
  const {token} = getSession();
  if(!token) return showMsg($('msg2'), 'Faça login primeiro.', false);
  if(!CONFIG) return showMsg($('msg2'), 'Config não carregada. Saia e faça login novamente.', false);

  const payload = readPayload();
  const calc = calcTotal(payload, CONFIG);

  // grava campos úteis para CRM
  payload.total_estimado = calc.totalGeral;
  payload.custas_previstas = calc.custasPrevistas;
  payload.valor_a_financiar = calc.valorAFinanciar;
  payload.last_calc_json = JSON.stringify(calc);

  // defaults CRM
  payload.status = payload.status || 'NOVO';
  payload.next_action_at = payload.next_action_at || '';
  payload.notes = payload.notes || '';

  const r = await saveLead(token, payload);
  showMsg($('msg2'), r.ok ? 'Lead salvo como NOVO HISTÓRICO (nova linha).' : (r.error || 'Erro ao salvar'), !!r.ok);
};

$('btnPDF').onclick = ()=> window.print();

// listeners
$('operacao').onchange = toggleTerrenoUI;
$('terreno_proprio').onchange = toggleTerrenoUI;
$('cidade').onchange = toggleCalcadaUI;
$('possui_calcada').onchange = toggleCalcadaUI;

// init
setDefaults();
refreshMenu();
toggleTerrenoUI();
toggleCalcadaUI();

$('btnChangePass').onclick = async ()=>{
  try{
    const {token, user} = getSession();
    if(!token) return showMsg($('msgPass'), 'Sem sessão. Faça login novamente.', false);

    const newPassword = $('newPass').value;
    const confirmPassword = $('newPass2').value;

    const r = await apiPost({ action:'changePassword', token, newPassword, confirmPassword });
    if(!r.ok) return showMsg($('msgPass'), r.error || 'Erro ao trocar senha.', false);

    showMsg($('msgPass'), 'Senha alterada com sucesso. Faça login novamente.', true);

    // encerra sessão e força login de novo
    clearSession();
    refreshMenu();
    unlockAfterPasswordChange();
    $('newPass').value = '';
    $('newPass2').value = '';
  } catch(e){
    showMsg($('msgPass'), String(e), false);
  }
};

$('btnChangePassLogout').onclick = ()=>{
  doLogout();
  unlockAfterPasswordChange();
};

// auto-carregar lead se já existe em localStorage e usuário já está logado
(async function boot(){
  const {token} = getSession();
  if(token){
    try{
      refreshMenu();
      if(user && user.mustChangePassword){
        lockForPasswordChange();
        return;
      }
      
      await loadAfterLogin(token);
      const toLoad = getLeadToLoad();
      if(toLoad){
        fillFormFromLead(toLoad);
        clearLeadToLoad();
        showMsg($('msg2'), 'Lead carregado do CRM.', true);
      }
    }catch(_){
      // token expirou; deixa login aparecer
      doLogout();
    }
  }
})();
</script>
</body>
</html>

